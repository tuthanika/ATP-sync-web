<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Alist-Sync 配置</title>
  <link href="../static/layui/css/layui.css" rel="stylesheet">
  
  <style>
    .main-container {
      width: 80%;
      margin: 20px auto;
      max-width: 1200px;
    }
    .page-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .page-header img {
      width: 64px;
      height: 64px;
    }
    .page-header h1 {
      margin: 10px 0;
      color: #009688;
    }
    .layui-btn-gray {
      background-color: #CCCCCC;
    }
    .next-run-time {
      padding: 5px 0;
      line-height: 1.8;
      color: #666;
    }
    .next-run-time div {
      margin-bottom: 3px;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="page-header">
      <img src="../static/images/logo.png" alt="Alist-Sync">
      <h1>Alist-Sync 配置中心</h1>
    </div>

    <form class="layui-form" action="javascript:void(0);">
      <!-- 基础参数设置 -->
      <div class="layui-card">
        <div class="layui-card-header">基础连接参数</div>
        <div class="layui-card-body">
          <div class="layui-form-item">
            <label class="layui-form-label">服务地址</label>
            <div class="layui-input-inline">
              <input type="text" name="baseUrl" required lay-verify="required" placeholder="请输入URL"
                autocomplete="off" class="layui-input">
            </div>
            <div class="layui-form-mid layui-text-em">必填项</div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline">
              <input type="text" name="username" required lay-verify="required" placeholder="请输入用户名"
                autocomplete="off" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-inline">
              <input type="password" name="password" required lay-verify="required" placeholder="请输入密码"
                autocomplete="off" class="layui-input">
            </div>
          </div>

          <div class="layui-form-item">
            <div class="layui-input-block">
              <button type="button" class="layui-btn layui-btn-gray" id="testConnect">测试连接</button>
              <button type="button" class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBaseConfig">保存连接配置</button>
              <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 同步设置 -->
      <div class="layui-card" style="margin-top: 15px;">
        <div class="layui-card-header">
          同步配置
          <button type="button" class="layui-btn layui-btn-xs layui-btn-normal" id="addTask">
            <i class="layui-icon">&#xe654;</i> 添加任务
          </button>
        </div>
        <div class="layui-card-body">
          <!-- 任务列表 -->
          <div id="taskList">
            <!-- 任务模板 -->
            <div class="task-item" data-task-id="1">
              <!-- 任务名称 -->
              <div class="layui-form-item">
                <label class="layui-form-label">任务名称</label>
                <div class="layui-input-inline">
                  <input type="text" name="taskName[]" placeholder="请输入任务名称" class="layui-input">
                </div>
                <div class="layui-form-mid">
                  <button type="button" class="layui-btn layui-btn-xs layui-btn-danger remove-task">
                    <i class="layui-icon">&#xe640;</i>
                  </button>
                </div>
              </div>

              <!-- 同步模式选择 -->
              <div class="layui-form-item">
                <label class="layui-form-label">同步模式</label>
                <div class="layui-input-block">
                  <input type="radio" name="syncMode_1" value="data" title="数据同步" checked lay-filter="syncMode">
                  <input type="radio" name="syncMode_1" value="file" title="文件同步" lay-filter="syncMode">
                </div>
              </div>

              <!-- 数据同步配置 -->
              <div class="data-sync-config" id="dataSyncConfig_1">
                <div class="layui-form-item">
                  <label class="layui-form-label">源存储器</label>
                  <div class="layui-input-inline">
                    <select name="sourceStorage_1">
                      <option value="">请选择</option>
                    </select>
                  </div>
                </div>

                <div class="layui-form-item">
                  <label class="layui-form-label">目标存储器</label>
                  <div class="layui-input-block target-storages" style="padding: 9px 15px;">
                    <!-- 动态添加复选框 -->
                  </div>
                </div>

                <!-- 添加同步目录输入 -->
                <div class="layui-form-item">
                  <label class="layui-form-label">同步目录</label>
                  <div class="layui-input-inline" style="width: 400px;">
                    <input type="text" name="syncDirs[]" placeholder="多个目录用英文逗号分隔" class="layui-input">
                  </div>
                </div>
              </div>

              <!-- 文件同步配置 -->
              <div class="file-sync-config" id="fileSyncConfig_1" style="display:none;">
                <div id="pathPairs_1">
                  <div class="layui-form-item path-pair">
                    <label class="layui-form-label">源目录</label>
                    <div class="layui-input-inline" style="width: 250px;">
                      <input type="text" name="srcPath_1[]" placeholder="输入源目录" class="layui-input">
                    </div>
                    <label class="layui-form-label">目标目录</label>
                    <div class="layui-input-inline" style="width: 250px;">
                      <input type="text" name="dstPath_1[]" placeholder="输入目标目录" class="layui-input">
                    </div>
                    <div class="layui-inline" style="margin-left: 10px;">
                      <button type="button" class="layui-btn layui-btn-primary layui-btn-sm add-path">
                        <i class="layui-icon">&#xe654;</i>
                      </button>
                      <button type="button" class="layui-btn layui-btn-primary layui-btn-sm remove-path">
                        <i class="layui-icon">&#xe67e;</i>
                      </button>
                    </div>
                    <hr class="layui-border-green" style="margin: 5px 0;">
                  </div>
                </div>
              </div>

              <!-- 共同配置项 -->
              <div class="layui-form-item">
                <label class="layui-form-label">排除目录</label>
                <div class="layui-input-inline" style="width: 400px;">
                  <input type="text" name="excludeDirs[]" placeholder="多个目录用英文逗号分隔" class="layui-input">
                </div>
              </div>

              <div class="layui-form-item">
                <label class="layui-form-label">定时调度器</label>
                <div class="layui-input-inline" style="width: 200px;">
                  <input type="text" name="cron[]" class="layui-input cron-input" placeholder="格式: * * * * *">
                </div>
                <div class="layui-inline">
                  <button type="button" class="layui-btn layui-btn-primary check-next-time">查看时间</button>
                </div>
              </div>

              <!-- 在定时调度器后添加下次执行时间显示 -->
              <div class="layui-form-item">
                <label class="layui-form-label">下次执行时间</label>
                <div class="layui-input-inline">
                  <div class="next-run-time" style="padding: 9px 15px; line-height: 20px; color: #666;"></div>
                </div>
              </div>

              <hr class="layui-border-green">
            </div>
          </div>
        </div>
      </div>

      <!-- 操作按钮 -->
      <div class="layui-form-item" style="margin-top: 15px;">
        <div class="layui-input-block" style="margin-left: 110px;">
          <button type="button" class="layui-btn" id="saveSyncConfig">保存同步配置</button>
          <button type="button" class="layui-btn layui-btn-normal" id="runTask">立即执行</button>
          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
      </div>
    </form>
  </div>

  <script src="../static/layui/layui.js"></script>

  <script>
  layui.use(['form', 'layer'], function(){
    var form = layui.form,
        layer = layui.layer,
        $ = layui.$;

    // 加载存储器列表
    function loadStorages() {
      $.ajax({
        url: '/api/storages',
        method: 'GET',
        success: function(res) {
          if(res.code === 200) {
            updateStorageSelects(res.data);
            updateStorageCheckboxes(res.data);
            form.render();
          }
        }
      });
    }

    // 更新源存储器下拉框
    function updateStorageSelects(data) {
      $('select[name^="sourceStorage_"]').each(function() {
        var $select = $(this);
        $select.empty().append('<option value="">请选择</option>');
        data.forEach(function(storage) {
          $select.append(
            '<option value="' + storage + '">' + storage.replace('/dav/', '') + '</option>'
          );
        });
      });
    }

    // 更新目标存储器复选框
    function updateStorageCheckboxes(data) {
      $('.target-storages').each(function() {
        var $targetDiv = $(this);
        var taskId = $targetDiv.closest('.task-item').attr('data-task-id');
        $targetDiv.empty();

        data.forEach(function(storage) {
          $targetDiv.append(
            '<input type="checkbox" name="targetStorages_' + taskId + '[]" value="' +
            storage + '" title="' + storage.replace('/dav/', '') + '" lay-skin="primary">'
          );
        });
      });
    }

    // 页面加载时获取存储器列表
    loadStorages();

    // 同步模式切换
    form.on('radio(syncMode)', function(data){
      var $task = $(data.elem).closest('.task-item');
      toggleSyncMode($task, data.value === 'file');
    });

    // 抽取同步模式切换逻辑
    function toggleSyncMode($task, isFileSync) {
      // 切换显示配置区域
      $task.find('.data-sync-config').toggle(!isFileSync);
      $task.find('.file-sync-config').toggle(isFileSync);

      if(isFileSync) {
        // 清空数据同步配置
        clearDataSyncInputs($task);
        // 确保至少有一对路径输入
        ensurePathPair($task);
      } else {
        // 清空文件同步配置
        clearFileSyncInputs($task);
      }

      form.render();
    }

    // 清空数据同步输入
    function clearDataSyncInputs($task) {
      $task.find('.data-sync-config input').val('');
      $task.find('.data-sync-config select').val('');
      $task.find('.data-sync-config input[type="checkbox"]').prop('checked', false);
    }

    // 清空文件同步输入
    function clearFileSyncInputs($task) {
      $task.find('.file-sync-config input').val('');
    }

    // 确保至少有一对路径输入
    function ensurePathPair($task) {
      var $pathPairs = $task.find('[id^="pathPairs_"]');
      if($pathPairs.find('.path-pair').length === 0) {
        addPathPair($pathPairs, $task.attr('data-task-id'));
      }
    }

    // 添加路径对的函数
    function addPathPair($container, taskId) {
      var $pathPair = $('<div class="layui-form-item path-pair">' +
        '<label class="layui-form-label">源目录</label>' +
        '<div class="layui-input-inline" style="width: 250px;">' +
          '<input type="text" name="srcPath_' + taskId + '[]" placeholder="输入源目录" class="layui-input">' +
        '</div>' +
        '<label class="layui-form-label">目标目录</label>' +
        '<div class="layui-input-inline" style="width: 250px;">' +
          '<input type="text" name="dstPath_' + taskId + '[]" placeholder="输入目标目录" class="layui-input">' +
        '</div>' +
        '<div class="layui-inline" style="margin-left: 10px;">' +
          '<button type="button" class="layui-btn layui-btn-primary layui-btn-sm add-path">' +
            '<i class="layui-icon">&#xe654;</i>' +
          '</button>' +
          '<button type="button" class="layui-btn layui-btn-primary layui-btn-sm remove-path">' +
            '<i class="layui-icon">&#xe67e;</i>' +
          '</button>' +
        '</div>' +
        '<hr class="layui-border-green" style="margin: 5px 0;">' +
      '</div>');

      $container.append($pathPair);
    }

    // 获取下次执行时间
    function updateNextRunTime($task, cronValue) {
      if(!cronValue) return;
      
      layer.load(1);
      
      $.ajax({
        url: '/api/next-run-time',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ cron: cronValue }),
        success: function(res) {
          layer.closeAll('loading');
          if(res.code === 200) {
            var $container = $task.find('.next-run-time');
            $container.empty();
            
            // 将每个时间点作为新行显示
            res.data.forEach(function(time) {
              $container.append(
                $('<div>').text(time)
              );
            });
          } else {
            layer.msg('获取下次执行时间失败: ' + (res.message || '未知错误'));
          }
        },
        error: function(xhr, status, error) {
          layer.closeAll('loading');
          layer.msg('请求失败: ' + (error || '未知错误'));
        }
      });
    }

    $('.check-next-time').on('click', function() {
      var $task = $(this).closest('.task-item');
      var cronValue = $task.find('.cron-input').val();
      
      if(!cronValue) {
        layer.msg('请先填写cron表达式');
        return;
      }
      
      updateNextRunTime($task, cronValue);
    });

    // 添加路径对
    $(document).on('click', '.add-path', function(){
      var $taskItem = $(this).closest('.task-item');
      var $pathPairs = $taskItem.find('[id^="pathPairs_"]');

      $pathPairs.find('.path-pair:last hr').remove();
      addPathPair($pathPairs, $taskItem.attr('data-task-id'));

      form.render();
    });

    // 删除路径对
    $(document).on('click', '.remove-path', function(){
      var $pathPairs = $(this).closest('[id^="pathPairs_"]');
      var $pathPair = $(this).closest('.path-pair');

      if($pathPairs.find('.path-pair').length > 1) {
        $pathPair.remove();
        ensureLastPathPairHasHr($pathPairs);
      } else {
        layer.msg('至少保留一对目录');
      }
    });

    // 确保最后一个路径对分隔线
    function ensureLastPathPairHasHr($pathPairs) {
      var $lastPair = $pathPairs.find('.path-pair:last');
      if(!$lastPair.find('hr').length) {
        $lastPair.append('<hr class="layui-border-green" style="margin: 5px 0;">');
      }
    }

    // 添加任务
    $('#addTask').on('click', function(){
      var taskId = $('.task-item').length + 1;
      var $newTask = createNewTask(taskId);
      $('#taskList').append($newTask);

      loadStorages();
      form.render();
    });

    // 创建新任务
    function createNewTask(taskId) {
      var $newTask = $('.task-item:first').clone();
      updateTaskIds($newTask, taskId);
      clearTaskInputs($newTask);

      // 设置默认配置
      $newTask.find('.data-sync-config').show();
      $newTask.find('.file-sync-config').hide();
      $newTask.find('input[name^="syncMode_"][value="data"]').prop('checked', true);

      // 重新绑定新任务的查看时间按钮事件
      $newTask.find('.check-next-time').on('click', function() {
        var $task = $(this).closest('.task-item');
        var cronValue = $task.find('.cron-input').val();
        
        if(!cronValue) {
          layer.msg('请先填写cron表达式');
          return;
        }
        
        updateNextRunTime($task, cronValue);
      });

      return $newTask;
    }

    // 更新任务ID
    function updateTaskIds($task, taskId) {
      $task.attr('data-task-id', taskId);
      $task.find('input[name^="syncMode_"]').attr('name', 'syncMode_' + taskId);
      $task.find('select[name^="sourceStorage_"]').attr('name', 'sourceStorage_' + taskId);
      $task.find('#pathPairs_1').attr('id', 'pathPairs_' + taskId);
      $task.find('input[name^="srcPath_"]').attr('name', 'srcPath_' + taskId + '[]');
      $task.find('input[name^="dstPath_"]').attr('name', 'dstPath_' + taskId + '[]');
      $task.find('#cronInput_1').attr('id', 'cronInput_' + taskId);
    }

    // 清空任务输入
    function clearTaskInputs($task) {
      $task.find('input[type="text"]').val('');
      $task.find('select').val('');
      $task.find('input[type="checkbox"]').prop('checked', false);

      // 设置默认同步模式为数据同步
      $task.find('input[name^="syncMode_"][value="data"]').prop('checked', true);
      $task.find('.data-sync-config').show();
      $task.find('.file-sync-config').hide();

      // 清空路径对容器
      var taskId = $task.attr('data-task-id');
      var $pathPairs = $task.find('#pathPairs_' + taskId);
      $pathPairs.empty();
      addPathPair($pathPairs, taskId);
    }

    // 删除任务
    $(document).on('click', '.remove-task', function(){
      var $taskItem = $(this).closest('.task-item');

      if($('.task-item').length === 1) {
        layer.msg('至少保留一个任务');
        return;
      }

      layer.confirm('确定要删除该任务吗？', function(index){
        $taskItem.remove();
        layer.close(index);
      });
    });

    // 测试连接
    var $baseUrl = $('input[name="baseUrl"]'),
        $username = $('input[name="username"]'),
        $password = $('input[name="password"]'),
        $testBtn = $('#testConnect'),
        isTestSuccess = false;

    $('input[name]').on('input', function(){
      var hasAllRequired = $baseUrl.val() && $username.val() && $password.val();
      $testBtn.toggleClass('layui-btn-gray', !hasAllRequired);
    });

    $testBtn.on('click', function(){
      if($(this).hasClass('layui-btn-normal')) return;

      if(!$baseUrl.val() || !$username.val() || !$password.val()){
        layer.msg('服务地址、用户名和密码均为必填项');
        return;
      }

      testConnection();
    });

    function testConnection() {
      var data = {
        baseUrl: $baseUrl.val(),
        username: $username.val(),
        password: $password.val()
      };

      layer.load(1);
      $.ajax({
        url: '/api/test-connection',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res){
          layer.closeAll('loading');
          if(res.code === 200){
            layer.msg('连接成功');
            $testBtn.removeClass('layui-btn-gray').addClass('layui-btn-normal');
            isTestSuccess = true;
          } else {
            layer.msg('连接失败: ' + res.message);
            $testBtn.addClass('layui-btn-gray').removeClass('layui-btn-normal');
            isTestSuccess = false;
          }
        },
        error: function(){
          layer.closeAll('loading');
          layer.msg('请求失败');
          $testBtn.addClass('layui-btn-gray').removeClass('layui-btn-normal');
          isTestSuccess = false;
        }
      });
    }

    // 保存基础配置
    form.on('submit(saveBaseConfig)', function(data){
      if(!isTestSuccess){
        layer.msg('请先进行测试连接并确保连接成功');
        return false;
      }

      saveBaseConfig(data.field);
      return false;
    });

    function saveBaseConfig(data) {
      layer.load(1);
      $.ajax({
        url: '/api/save-base-config',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          baseUrl: data.baseUrl,
          username: data.username,
          password: data.password
        }),
        success: function(res){
          layer.closeAll('loading');
          layer.msg(res.code === 200 ? '基础配置保存成功' : '保存失败: ' + res.message);
        },
        error: function(){
          layer.closeAll('loading');
          layer.msg('请求失败');
        }
      });
    }

    // 使用click事件绑定
    $('#saveSyncConfig').on('click', function() {
      var tasks = collectTaskData();
      if(!validateTasks(tasks)) {
        return;
      }
      saveSyncConfig(tasks);
    });

    // 保存同步配置的函数
    function saveSyncConfig(tasks) {
      layer.load(1);
      $.ajax({
        url: '/api/save-sync-config',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ tasks: tasks }),
        success: function(res){
          layer.closeAll('loading');
          if(res.code === 200) {
            layer.msg('同步配置保存成功');
          } else {
            layer.msg('保存失败: ' + (res.message || '未知错误'));
          }
        },
        error: function(xhr, status, error){
          layer.closeAll('loading');
          layer.msg('请求失败: ' + (error || '未知错误'));
        }
      });
    }

    // 添加任务数据验证
    function validateTasks(tasks) {
      if(!tasks || tasks.length === 0) {
        layer.msg('请至少配置一个同步任务');
        return false;
      }
      
      for(var i = 0; i < tasks.length; i++) {
        var task = tasks[i];
        if(!task.taskName) {
          layer.msg('请填写任务名称');
          return false;
        }
        if(task.syncMode === 'data') {
          if(!task.sourceStorage) {
            layer.msg('请选择源存储器');
            return false;
          }
          if(!task.targetStorages || task.targetStorages.length === 0) {
            layer.msg('请选择目标存储器');
            return false;
          }
        } else if(task.syncMode === 'file') {
          if(!task.paths || task.paths.length === 0) {
            layer.msg('请配置同步路径');
            return false;
          }
          for(var j = 0; j < task.paths.length; j++) {
            if(!task.paths[j].srcPath || !task.paths[j].dstPath) {
              layer.msg('请填写完整的源目录和目标目录');
              return false;
            }
          }
        }
      }
      return true;
    }

    function collectTaskData() {
      var tasks = [];
      $('.task-item').each(function(){
        var $task = $(this);
        var taskId = $task.attr('data-task-id');
        var syncMode = $task.find('input[name^="syncMode_"]:checked').val();

        var taskData = {
          taskName: $task.find('input[name="taskName[]"]').val().trim(),
          syncMode: syncMode,
          excludeDirs: $task.find('input[name="excludeDirs[]"]').val(),
          cron: $task.find('input[name="cron[]"]').val()
        };

        if(syncMode === 'data') {
          // 数据同步模式
          taskData.sourceStorage = $task.find('select[name^="sourceStorage_"]').val();
          taskData.targetStorages = [];
          taskData.syncDirs = $task.find('input[name="syncDirs[]"]').val();
          $task.find('input[name="targetStorages_' + taskId + '[]"]:checked').each(function(){
            taskData.targetStorages.push($(this).val());
          });
        } else {
          // 文件同步模式
          taskData.paths = [];
          $task.find('.path-pair').each(function(){
            taskData.paths.push({
              srcPath: $(this).find('input[name^="srcPath_"]').val(),
              dstPath: $(this).find('input[name^="dstPath_"]').val()
            });
          });
        }

        tasks.push(taskData);
      });
      return tasks;
    }

    // 修改立即执行的处理
    $('#runTask').on('click', function(){
      var tasks = collectTaskData();
      if(!validateTasks(tasks)) {
        return false;
      }
      
      layer.confirm('确定要立即执行同步任务吗？', function(index){
        layer.close(index);
        runTask(tasks);
      });
    });

    function runTask(tasks) {
      layer.load(1);
      $.ajax({
        url: '/api/run-task',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ tasks: tasks }),
        success: function(res){
          layer.closeAll('loading');
          layer.msg(res.code === 0 ? '任务已启动' : '同步失败: ' + res.msg);
        },
        error: function(){
          layer.closeAll('loading');
          layer.msg('请求失败');
        }
      });
    }

    // 页面加载时获取配置
    function loadConfigs() {
      $.ajax({
        url: '/api/get-base-config',
        method: 'GET',
        success: function(res) {
          if(res.code === 200) {
            $('input[name="baseUrl"]').val(res.data.baseUrl);
            $('input[name="username"]').val(res.data.username);
            $('input[name="password"]').val(res.data.password);
          }
        }
      });

      $.ajax({
        url: '/api/get-sync-config',
        method: 'GET',
        success: function(res) {
          if(res.code === 200 && res.data.length > 0) {
            $('#taskList').empty();
            res.data.forEach(function(task, index) {
              var taskId = index + 1;
              var $task = $('.task-item:first').clone();

              updateTaskIds($task, taskId);
              fillTaskData($task, task);

              $('#taskList').append($task);
            });

            form.render();
          }
        }
      });
    }

    function fillTaskData($task, task) {
      $task.find('input[name="taskName[]"]').val(task.taskName);

      // 设置同步模式并显示对应配置
      var $modeRadio = $task.find('input[name^="syncMode_"][value="' + task.syncMode + '"]');
      $modeRadio.prop('checked', true);

      if(task.syncMode === 'data') {
        // 数据同步模式
        $task.find('.data-sync-config').show();
        $task.find('.file-sync-config').hide();

        $task.find('select[name^="sourceStorage_"]').val(task.sourceStorage);
        $task.find('input[name="syncDirs[]"]').val(task.syncDirs);

        // 填充目标存储器选择
        if(task.targetStorages) {
          task.targetStorages.forEach(function(storage) {
            $task.find('input[name^="targetStorages_"][value="' + storage + '"]').prop('checked', true);
          });
        }
      } else {
        // 文���同步模式
        $task.find('.data-sync-config').hide();
        $task.find('.file-sync-config').show();

        // 填充路径对
        if(task.paths && task.paths.length) {
          var $pathPairs = $task.find('#pathPairs_' + $task.attr('data-task-id'));
          $pathPairs.empty();

          task.paths.forEach(function(path, index) {
            if(index === 0) {
              // 第一个路径对
              addPathPair($pathPairs, $task.attr('data-task-id'));
              var $firstPair = $pathPairs.find('.path-pair:first');
              $firstPair.find('input[name^="srcPath_"]').val(path.srcPath);
              $firstPair.find('input[name^="dstPath_"]').val(path.dstPath);
            } else {
              // 添加额外的路径对
              addPathPair($pathPairs, $task.attr('data-task-id'));
              var $lastPair = $pathPairs.find('.path-pair:last');
              $lastPair.find('input[name^="srcPath_"]').val(path.srcPath);
              $lastPair.find('input[name^="dstPath_"]').val(path.dstPath);
            }
          });
        } else {
          // 确保至少有一个空的路径对
          var $pathPairs = $task.find('#pathPairs_' + $task.attr('data-task-id'));
          $pathPairs.empty();
          addPathPair($pathPairs, $task.attr('data-task-id'));
        }
      }

      $task.find('input[name="excludeDirs[]"]').val(task.excludeDirs);
      $task.find('input[name="cron[]"]').val(task.cron);

      // 更新下次执行时间
      if(task.cron) {
        updateNextRunTime($task, task.cron);
      }

      form.render();
    }

    loadConfigs();

    // 修改重置按钮的处理
    $('button[type="reset"]').on('click', function(){
      // 只清空同步配置区域的输入
      var $taskList = $('#taskList');
      
      // 清空每个任务的输入
      $taskList.find('.task-item').each(function(){
        var $task = $(this);
        // 清空任务名称
        $task.find('input[name="taskName[]"]').val('');
        
        // 重置同步模式为数据同步
        $task.find('input[name^="syncMode_"][value="data"]').prop('checked', true);
        $task.find('.data-sync-config').show();
        $task.find('.file-sync-config').hide();
        
        // 清空数据同步配置
        $task.find('select[name^="sourceStorage_"]').val('');
        $task.find('input[name^="targetStorages_"]').prop('checked', false);
        $task.find('input[name="syncDirs[]"]').val('');
        
        // 清空文件同步配置
        var $pathPairs = $task.find('[id^="pathPairs_"]');
        $pathPairs.empty();
        addPathPair($pathPairs, $task.attr('data-task-id'));
        
        // 清空共同配置
        $task.find('input[name="excludeDirs[]"]').val('');
        $task.find('input[name="cron[]"]').val('');
        $task.find('.next-run-time').empty();
      });
      
      // 重新渲染表单
      form.render();
      
      return false; // 阻止表单默认重置行为
    });
  });
  </script>
</body>
</html>