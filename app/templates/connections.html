{% extends "base.html" %}

{% block title %}Quản lý kết nối - Alist-Sync{% endblock %}

{% block page_title %}Quản lý kết nối{% endblock %}

{% block header_buttons %}
<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConnectionModal">
    <i class="bi bi-plus-lg"></i> Thêm một kết nối
</button>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card bg-dark-subtle">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>tên</th>
                                <th>Địa chỉ máy chủ</th>
                                <th>tình trạng</th>
                                <th>Thời gian sáng tạo</th>
                                <th>Cập nhật thời gian</th>
                                <th>vận hành</th>
                            </tr>
                        </thead>
                        <tbody id="connections-table">
                            {% if connections %}
                                {% for conn in connections %}
                                <tr>
                                    <td>{{ conn.connection_id }}</td>
                                    <td>{{ conn.name }}</td>
                                    <td>{{ conn.server }}</td>
                                    <td>
                                        {% if conn.status == 'online' %}
                                        <span class="badge bg-success">Trực tuyến</span>
                                        {% else %}
                                        <span class="badge bg-danger">Ngoại tuyến</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ conn.created_at }}</td>
                                    <td>{{ conn.updated_at }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary edit-connection" data-conn-id="{{ conn.connection_id }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-info test-connection" data-conn-id="{{ conn.connection_id }}">
                                                <i class="bi bi-check2-circle"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-connection" data-conn-id="{{ conn.connection_id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">Chưa kết nối</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm một hộp phương thức kết nối -->
<div class="modal fade" id="addConnectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Thêm vào Alist kết nối</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="connectionForm">
                    <div class="mb-3">
                        <label for="connName" class="form-label">Tên kết nối</label>
                        <input type="text" class="form-control bg-dark text-light" id="connName" required>
                    </div>
                    <div class="mb-3">
                        <label for="connServer" class="form-label">Địa chỉ máy chủ</label>
                        <input type="url" class="form-control bg-dark text-light" id="connServer" placeholder="https://your-alist-server.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="connUser" class="form-label">Tên người dùng</label>
                        <input type="text" class="form-control bg-dark text-light" id="connUser">
                    </div>
                    <div class="mb-3">
                        <label for="connPassword" class="form-label">mật khẩu</label>
                        <div class="input-group">
                            <input type="password" class="form-control bg-dark text-light" id="connPassword">
                            <button class="btn btn-outline-secondary bg-dark text-light password-toggle" type="button" data-target="connPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="connToken" class="form-label">API Mã thông báo</label>
                        <div class="input-group">
                            <input type="password" class="form-control bg-dark text-light" id="connToken" placeholder="Không bắt buộc，Ưu tiên sử dụng xác thực mã thông báo">
                            <button class="btn btn-outline-secondary bg-dark text-light password-toggle" type="button" data-target="connToken">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="connProxy" class="form-label">Cài đặt proxy (Không bắt buộc)</label>
                        <input type="text" class="form-control bg-dark text-light" id="connProxy" placeholder="http://proxy:port">
                    </div>
                    <div class="mb-3">
                        <label for="connMaxRetry" class="form-label">Số lượng thử lại tối đa</label>
                        <input type="number" class="form-control bg-dark text-light" id="connMaxRetry" value="3" min="0" max="10">
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="connInsecure">
                        <label class="form-check-label" for="connInsecure">Cho phép không an toàn HTTPS kết nối (Giấy chứng nhận tự ký)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-info" id="testConnectionBtn">Kết nối kiểm tra</button>
                <button type="button" class="btn btn-primary" id="saveConnectionBtn">Lưu kết nối</button>
            </div>
        </div>
    </div>
</div>

<!-- Chỉnh sửa hộp kết nối Modal -->
<div class="modal fade" id="editConnectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">biên tập Alist kết nối</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editConnectionForm">
                    <input type="hidden" id="editConnId">
                    <div class="mb-3">
                        <label for="editConnName" class="form-label">Tên kết nối</label>
                        <input type="text" class="form-control bg-dark text-light" id="editConnName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editConnServer" class="form-label">Địa chỉ máy chủ</label>
                        <input type="url" class="form-control bg-dark text-light" id="editConnServer" placeholder="https://your-alist-server.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="editConnUser" class="form-label">Tên người dùng</label>
                        <input type="text" class="form-control bg-dark text-light" id="editConnUser">
                    </div>
                    <div class="mb-3">
                        <label for="editConnPassword" class="form-label">mật khẩu</label>
                        <div class="input-group">
                            <input type="password" class="form-control bg-dark text-light" id="editConnPassword">
                            <button class="btn btn-outline-secondary bg-dark text-light password-toggle" type="button" data-target="editConnPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editConnToken" class="form-label">API Mã thông báo</label>
                        <div class="input-group">
                            <input type="password" class="form-control bg-dark text-light" id="editConnToken" placeholder="Không bắt buộc，Ưu tiên sử dụng xác thực mã thông báo">
                            <button class="btn btn-outline-secondary bg-dark text-light password-toggle" type="button" data-target="editConnToken">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editConnProxy" class="form-label">Cài đặt proxy (Không bắt buộc)</label>
                        <input type="text" class="form-control bg-dark text-light" id="editConnProxy" placeholder="http://proxy:port">
                    </div>
                    <div class="mb-3">
                        <label for="editConnMaxRetry" class="form-label">Số lượng thử lại tối đa</label>
                        <input type="number" class="form-control bg-dark text-light" id="editConnMaxRetry" value="3" min="0" max="10">
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="editConnInsecure">
                        <label class="form-check-label" for="editConnInsecure">Cho phép không an toàn HTTPS kết nối (Giấy chứng nhận tự ký)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-info" id="editTestConnectionBtn">Kiểm tra kết nối</button>
                <button type="button" class="btn btn-primary" id="updateConnectionBtn">Cập nhật kết nối</button>
            </div>
        </div>
    </div>
</div>

<!-- Xác nhận hộp phương thức xóa -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc là bạn muốn xóa kết nối này?？Hoạt động này không được khôi phục，Và có thể ảnh hưởng đến các tác vụ đồng bộ hóa phụ thuộc vào kết nối này。</p>
                <input type="hidden" id="deleteConnId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xác nhận xóa</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Thêm một sự kiện kết nối
        document.getElementById('saveConnectionBtn').addEventListener('click', function() {
            // Xác minh các trường bắt buộc
            const connName = document.getElementById('connName');
            const connServer = document.getElementById('connServer');
            
            if (!connName.value.trim()) {
                showMessage('warning', 'Vui lòng nhập tên kết nối');
                connName.focus();
                return;
            }
            
            if (!connServer.value.trim()) {
                showMessage('warning', 'Vui lòng nhập địa chỉ máy chủ');
                connServer.focus();
                return;
            }
            
            // Tắt nút，Hiển thị trạng thái tải
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Tiết kiệm...';
            
            // Nhận trạng thái kết nối - Tình trạng sử dụng kết quả kiểm tra
            const connectionForm = document.getElementById('connectionForm');
            let connectionStatus = connectionForm.dataset.connectionStatus || 'offline';
            
            // Chuẩn bị dữ liệu biểu mẫu
            const connection = {
                name: connName.value,
                server: connServer.value,
                username: document.getElementById('connUser').value,
                password: document.getElementById('connPassword').value,
                token: document.getElementById('connToken').value,
                proxy: document.getElementById('connProxy').value,
                max_retry: document.getElementById('connMaxRetry').value,
                insecure: document.getElementById('connInsecure').checked,
                status: connectionStatus
            };
            
            // Gửi yêu cầu lưu
            fetch('/api/connections', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(connection)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi phản hồi mạng');
                }
                return response.json();
            })
            .then(data => {
                showMessage('success', 'Kết nối được thêm vào');
                hideAddModal();
                
                // Tải lại danh sách
                setTimeout(() => {
                    location.reload();
                }, 1000);
            })
            .catch(error => {
                console.error('Lưu kết nối không thành công:', error);
                showMessage('danger', 'Lưu kết nối không thành công: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                this.disabled = false;
                this.innerHTML = 'Lưu kết nối';
            });
        });
        
        // Nút kết nối kiểm tra - Thích hợp cho chế độ mới
        document.getElementById('testConnectionBtn').addEventListener('click', function() {
            const server = document.getElementById('connServer').value;
            if (!server) {
                showMessage('warning', 'Vui lòng nhập địa chỉ máy chủ');
                return;
            }
            
            // Tắt nút，Hiển thị trạng thái tải
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Trong thử nghiệm...';
            
            // Chuẩn bị dữ liệu kiểm tra
            const testData = {
                server: server,
                username: document.getElementById('connUser').value,
                password: document.getElementById('connPassword').value,
                token: document.getElementById('connToken').value,
                insecure: document.getElementById('connInsecure').checked
            };
            
            // Gửi yêu cầu kiểm tra
            fetch('/api/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi phản hồi mạng');
                }
                return response.json();
            })
            .then(data => {
                // Lưu trạng thái kết nối vào biểu mẫu，Để lưu trữ sau này
                const connectionForm = document.getElementById('connectionForm');
                connectionForm.dataset.connectionStatus = data.data.connection_status;
                
                if (data.status === 'success') {
                    // Nếu có được mã thông báo mới，Cập nhật hộp đầu vào mã thông báo
                    if (data.data && data.data.token) {
                        document.getElementById('connToken').value = data.data.token;
                    }
                    
                    showMessage('success', 'Kiểm tra kết nối thành công');
                } else {
                    showMessage('danger', data.message || 'Kiểm tra kết nối không thành công');
                }
            })
            .catch(error => {
                console.error('Kết nối kiểm tra không thành công:', error);
                showMessage('danger', 'Kết nối kiểm tra không thành công: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                this.disabled = false;
                this.innerHTML = originalHTML;
            });
        });
        
        // Chỉnh sửa nút kết nối
        document.querySelectorAll('.edit-connection').forEach(button => {
            button.addEventListener('click', function() {
                const connId = this.getAttribute('data-conn-id');
                
                // Tắt nút，Hiển thị trạng thái tải
                this.disabled = true;
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                
                // vượt quaAPINhận thông tin kết nối
                fetch(`/api/connections/${connId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không lấy được thông tin kết nối');
                    }
                    return response.json();
                })
                .then(conn => {
                    document.getElementById('editConnId').value = conn.connection_id;
                    document.getElementById('editConnName').value = conn.name;
                    document.getElementById('editConnServer').value = conn.server;
                    document.getElementById('editConnUser').value = conn.username;
                    
                    // Đặt giá trị mật khẩu
                    if(conn.password) {
                        document.getElementById('editConnPassword').value = conn.password;
                    }
                    
                    document.getElementById('editConnToken').value = conn.token || '';
                    document.getElementById('editConnProxy').value = conn.proxy || '';
                    document.getElementById('editConnMaxRetry').value = conn.max_retry || 3;
                    document.getElementById('editConnInsecure').checked = conn.insecure === true;
                    
                    // Lưu trạng thái kết nối vào dữ liệu biểu mẫu
                    const connectionForm = document.getElementById('editConnectionForm');
                    connectionForm.dataset.connectionStatus = conn.status || 'offline';
                    
                    // Hiển thị hộp phương thức
                    new bootstrap.Modal(document.getElementById('editConnectionModal')).show();
                })
                .catch(error => {
                    console.error('Không lấy được thông tin kết nối:', error);
                    alert('Không lấy được thông tin kết nối: ' + error.message);
                })
                .finally(() => {
                    // Khôi phục trạng thái nút
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                });
            });
        });
        
        // Cập nhật nút kết nối
        document.getElementById('updateConnectionBtn').addEventListener('click', function() {
            // Nhận dữ liệu biểu mẫu
            const connId = document.getElementById('editConnId').value;
            
            // Hiển thị trạng thái tải
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Cập nhật...';
            
            // Nhận trạng thái kết nối
            const connectionForm = document.getElementById('editConnectionForm');
            const connectionStatus = connectionForm.dataset.connectionStatus || 'offline';
            
            // Nhật ký gỡ lỗi
            console.log("Cập nhật trạng thái trước khi kết nối:", connectionStatus, "Hình thức dữ liệu:", connectionForm.dataset);
            
            // Xây dựng dữ liệu kết nối
            const connection = {
                connection_id: parseInt(connId),
                name: document.getElementById('editConnName').value,
                server: document.getElementById('editConnServer').value,
                username: document.getElementById('editConnUser').value,
                password: document.getElementById('editConnPassword').value,
                token: document.getElementById('editConnToken').value,
                proxy: document.getElementById('editConnProxy').value,
                max_retry: document.getElementById('editConnMaxRetry').value,
                insecure: document.getElementById('editConnInsecure').checked,
                status: connectionStatus
            };
            
            // Gửi yêu cầu cập nhật
            fetch(`/api/connections/${connId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(connection)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi phản hồi mạng');
                }
                return response.json();
            })
            .then(data => {
                showMessage('success', data.message);
                hideEditModal();
                
                // Tải lại danh sách
                setTimeout(() => {
                    location.reload();
                }, 1000);
            })
            .catch(error => {
                console.error('Cập nhật kết nối không thành công:', error);
                showMessage('danger', 'Cập nhật kết nối không thành công: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                this.disabled = false;
                this.innerHTML = 'Cập nhật kết nối';
            });
        });
        
        // Nút kết nối kiểm tra - Áp dụng cho chế độ chỉnh sửa
        document.getElementById('editTestConnectionBtn').addEventListener('click', function() {
            // Tắt nút，Hiển thị trạng thái tải
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Trong thử nghiệm...';
            
            // Nhận kết nốiID
            const connId = document.getElementById('editConnId').value;
            
            // Chuẩn bị dữ liệu kiểm tra
            const testData = {
                connection_id: parseInt(connId),
                server: document.getElementById('editConnServer').value,
                username: document.getElementById('editConnUser').value,
                token: document.getElementById('editConnToken').value,
                insecure: document.getElementById('editConnInsecure').checked
            };
            
            // Chỉ bao gồm trong yêu cầu nếu trường Mật khẩu có giá trị
            const password = document.getElementById('editConnPassword').value;
            if (password) {
                testData.password = password;
            }
            
            // Gửi yêu cầu kiểm tra
            fetch('/api/test-connection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi phản hồi mạng');
                }
                return response.json();
            })
            .then(data => {
                // Lưu trạng thái kết nối vào biểu mẫu，Để lưu trữ sau này
                const connectionForm = document.getElementById('editConnectionForm');
                connectionForm.dataset.connectionStatus = data.data.connection_status;
                
                // Nhật ký gỡ lỗi
                console.log("Đặt trạng thái sau khi kết nối kiểm tra:", data.data.connection_status);
                
                if (data.status === 'success') {
                    // Nếu có được mã thông báo mới，Cập nhật hộp đầu vào mã thông báo
                    if (data.data && data.data.token) {
                        document.getElementById('editConnToken').value = data.data.token;
                    }
                    
                    // Cập nhật ngay bây giờUIHiển thị trạng thái kết nối
                    const statusBadgeHtml = `<span class="badge bg-success">Trực tuyến</span>`;
                    document.querySelector(`.test-connection[data-conn-id="${connId}"]`)
                        .closest('tr')
                        .querySelector('td:nth-child(4)')
                        .innerHTML = statusBadgeHtml;
                    
                    showMessage('success', 'Kiểm tra kết nối thành công，Trạng thái đã được cập nhật để"Trực tuyến"');
                } else {
                    // Cập nhật ngay bây giờUIHiển thị trạng thái kết nối
                    const statusBadgeHtml = `<span class="badge bg-danger">Ngoại tuyến</span>`;
                    document.querySelector(`.test-connection[data-conn-id="${connId}"]`)
                        .closest('tr')
                        .querySelector('td:nth-child(4)')
                        .innerHTML = statusBadgeHtml;
                    
                    showMessage('danger', data.message || 'Kiểm tra kết nối không thành công');
                }
            })
            .catch(error => {
                console.error('Kết nối kiểm tra không thành công:', error);
                showMessage('danger', 'Kết nối kiểm tra không thành công: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                this.disabled = false;
                this.innerHTML = originalHTML;
            });
        });
        
        // Xóa sự kiện nút kết nối
        document.querySelectorAll('.delete-connection').forEach(button => {
            button.addEventListener('click', function() {
                const connId = this.getAttribute('data-conn-id');
                const connName = this.closest('tr').querySelector('td:nth-child(2)').textContent;
                
                if (!confirm(`Xác nhận để xóa kết nối "${connName}" Là nó？Hoạt động này không được khôi phục。`)) {
                    return;
                }
                
                // Tắt nút，Hiển thị trạng thái tải
                this.disabled = true;
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                
                fetch(`/api/connections/${connId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Lỗi phản hồi mạng');
                    }
                    return response.json();
                })
                .then(data => {
                    showMessage('success', `kết nối "${connName}" Đã xóa`);
                    
                    // Xóa hàng khỏi bảng
                    this.closest('tr').remove();
                    
                    // Nếu bàn trống，trình diễn"Chưa kết nối"thông tin
                    const table = document.getElementById('connections-table');
                    if (table.children.length === 0) {
                        table.innerHTML = '<tr><td colspan="7" class="text-center">Chưa kết nối</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Không xóa kết nối:', error);
                    showMessage('danger', 'Không xóa kết nối: ' + error.message);
                    
                    // Khôi phục trạng thái nút
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                });
            });
        });
        
        // Nút kết nối kiểm tra（Danh sách của）
        document.querySelectorAll('.test-connection').forEach(button => {
            button.addEventListener('click', function() {
                const connId = this.getAttribute('data-conn-id');
                
                // Hiển thị trạng thái trong bài kiểm tra
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                this.disabled = true;
                
                // Nhận thẻ trạng thái cho kết nối
                const statusBadge = this.closest('tr').querySelector('td:nth-child(4) .badge');
                
                // Nhận thông tin về kết nối này
                fetch(`/api/connections/${connId}`)
                .then(response => response.json())
                .then(connection => {
                    // Nếu thông tin kết nối thành công，Tiến hành kiểm tra kết nối
                    if (connection) {
                        const connectionData = {
                            connection_id: parseInt(connId), // sử dụngconnection_id
                            server: connection.server,
                            username: connection.username,
                            password: connection.password,
                            token: connection.token
                        };
                        
                        return fetch('/api/test-connection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(connectionData),
                        });
                    } else {
                        throw new Error('Không thể có được thông tin kết nối');
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Cập nhật ngay bây giờUItrình diễn
                        if (statusBadge) {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = 'Trực tuyến';
                        }
                        
                        showMessage('success', 'Kiểm tra kết nối thành công');
                    } else {
                        // Cập nhật ngay bây giờUItrình diễn
                        if (statusBadge) {
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = 'Ngoại tuyến';
                        }
                        
                        showMessage('danger', `Kiểm tra kết nối không thành công: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Kết nối kiểm tra không thành công:', error);
                    
                    // Được cập nhật lên trạng thái ngoại tuyến khi xảy ra lỗi
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-danger';
                        statusBadge.textContent = 'Ngoại tuyến';
                    }
                    
                    showMessage('danger', `Kết nối kiểm tra không thành công: ${error.message}`);
                })
                .finally(() => {
                    // Khôi phục trạng thái nút
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                });
            });
        });

        // Hiển thị mật khẩu/Ẩn chức năng chuyển đổi
        document.querySelectorAll('.password-toggle').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const inputField = document.getElementById(targetId);
                const icon = this.querySelector('i');
                
                if (inputField.type === 'password') {
                    inputField.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    inputField.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });
        });

        // Chức năng trợ giúp：Hiển thị lời nhắc tin nhắn
        function showMessage(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show fixed-top w-50 mx-auto mt-3`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // 3Tự động đóng trong vài giây
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(alertDiv);
                }, 150);
            }, 3000);
        }
        
        // Chức năng trợ giúp：Ẩn thêm hộp phương thức
        function hideAddModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('addConnectionModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        // Chức năng trợ giúp：Ẩn Box Modal EDIT
        function hideEditModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editConnectionModal'));
            if (modal) {
                modal.hide();
            }
        }
    });
</script>
{% endblock %} 