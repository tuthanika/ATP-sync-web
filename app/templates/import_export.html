{% extends "base.html" %}

{% block title %}Nhập và xuất dữ liệu - Alist-Sync{% endblock %}

{% block page_title %}Nhập và xuất dữ liệu{% endblock %}

{% block content %}
<div class="row">
    <!-- Xuất dữ liệu hệ thống -->
    <div class="col-md-6 mb-4">
        <div class="card bg-dark text-light">
            <div class="card-header bg-dark bg-opacity-50">
                <h5><i class="bi bi-download me-2"></i>Xuất dữ liệu hệ thống</h5>
            </div>
            <div class="card-body">
                <p>Xuất tất cả dữ liệu cấu hình của hệ thống hiện tại，bao gồm：</p>
                <ul>
                    <li>Dữ liệu người dùng (users.json)</li>
                    <li>Cấu hình kết nối (connections.json)</li>
                    <li>Cấu hình nhiệm vụ (tasks.json)</li>
                    <li>Cài đặt hệ thống (settings.json)</li>
                </ul>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>Dữ liệu được xuất có thể được sử dụng để sao lưu hoặc di chuyển sang các hệ thống khác。
                </div>
                <button id="export-btn" class="btn btn-primary mt-3">
                    <i class="bi bi-download me-2"></i>Xuất dữ liệu
                </button>
            </div>
        </div>
    </div>

    <!-- Nhập dữ liệu hệ thống -->
    <div class="col-md-6 mb-4">
        <div class="card bg-dark text-light">
            <div class="card-header bg-dark bg-opacity-50">
                <h5><i class="bi bi-upload me-2"></i>Nhập dữ liệu hệ thống</h5>
            </div>
            <div class="card-body">
                <p>Nhập dữ liệu cấu hình hệ thống，Sẽ bao gồm tất cả các cấu hình của hệ thống hiện tại。</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Nhập dữ liệu sẽ thay thế tất cả các cấu hình của hệ thống hiện tại，Tất cả dữ liệu kết nối và tác vụ sẽ hoàn toàn được ghi đè thay vì được thêm vào。Hệ thống sẽ tự động sao lưu dữ liệu hiện tại。
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>Hỗ trợ nhiều định dạng nhập：
                    <ul class="mb-0 mt-2">
                        <li>Định dạng tiêu chuẩn - Hoàn thành dữ liệu được xuất qua hệ thống này</li>
                        <li>Phiên bản cũ Cấu hình cơ bản - Phiên bản cũAList-SyncTệp cấu hình cơ bản，Chứa địa chỉ máy chủ vàToken</li>
                        <li>Cấu hình đồng bộ hóa phiên bản cũ - Phiên bản cũAList-SyncTệp cấu hình tác vụ đồng bộ</li>
                        <li>Phiên bản mới Cấu hình đồng bộ - Phiên bản mớiAList-SyncTệp cấu hình tác vụ đồng bộ，Chứa nguồn lưu trữ nguồn và mục tiêu</li>
                    </ul>
                </div>
                <div class="mb-3">
                    <label for="import-file" class="form-label">Chọn xuấtJSONtài liệu</label>
                    <input type="file" class="form-control" id="import-file" accept=".json">
                </div>
                <button id="import-btn" class="btn btn-warning mt-3" disabled>
                    <i class="bi bi-upload me-2"></i>Nhập dữ liệu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Nhập hộp kết quả kết quả -->
<div class="modal fade" id="import-result-modal" tabindex="-1" aria-labelledby="importResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="importResultModalLabel">Kết quả nhập</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body" id="import-result-content">
                <!-- Kết quả sẽ làJSĐộng lực điền vào -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Chức năng xuất
        $('#export-btn').click(function() {
            // Hiển thị hoạt hình tải
            $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>xuất...');
            $(this).prop('disabled', true);
            
            $.ajax({
                url: '/api/export',
                method: 'GET',
                success: function(response) {
                    if (response.status === 'success') {
                        // Tạo liên kết tải xuống
                        const exportData = JSON.stringify(response.data, null, 2);
                        const blob = new Blob([exportData], {type: 'application/json'});
                        const url = URL.createObjectURL(blob);
                        
                        // Tạo phần tử tải xuống và kích hoạt tải xuống
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `alist-sync-export-${timestamp}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } else {
                        alert('xuất không thành công: ' + response.message);
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'xuất không thành công';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMsg = response.message || errorMsg;
                    } catch (e) {
                        errorMsg = 'xuất không thành công，Lỗi máy chủ';
                    }
                    alert(errorMsg);
                },
                complete: function() {
                    // Khôi phục trạng thái nút
                    $('#export-btn').html('<i class="bi bi-download me-2"></i>Xuất dữ liệu');
                    $('#export-btn').prop('disabled', false);
                }
            });
        });
        
        // Cho phép/Tắt nút nhập
        $('#import-file').on('change', function() {
            $('#import-btn').prop('disabled', !this.files.length);
        });
        
        // Hàm nhập
        $('#import-btn').click(function() {
            const fileInput = document.getElementById('import-file');
            if (!fileInput.files.length) {
                alert('Vui lòng chọn tệp để nhập');
                return;
            }
            
            // Hiển thị hoạt hình tải
            $(this).html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang nhập...');
            $(this).prop('disabled', true);
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Xác nhận nhập
                    if (!confirm('Nhập sẽ ghi đè dữ liệu cấu hình hiện có，Tất cả dữ liệu kết nối và tác vụ sẽ được thay thế hoàn toàn thay vì được thêm vào，Xác nhận để tiếp tục？')) {
                        $('#import-btn').html('<i class="bi bi-upload me-2"></i>Nhập dữ liệu');
                        $('#import-btn').prop('disabled', false);
                        return;
                    }
                    
                    // Gửi yêu cầu nhập
                    $.ajax({
                        url: '/api/import',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({"data": importData}),
                        success: function(response) {
                            // Hiển thị kết quả trong hộp phương thức
                            let resultHTML = '';
                            
                            if (response.status === 'success') {
                                resultHTML += '<div class="alert alert-success mb-3">';
                                resultHTML += '<i class="bi bi-check-circle-fill me-2"></i>' + response.message;
                                resultHTML += '</div>';
                            } else {
                                resultHTML += '<div class="alert alert-danger mb-3">';
                                resultHTML += '<i class="bi bi-x-circle-fill me-2"></i>' + response.message;
                                resultHTML += '</div>';
                            }
                            
                            // Thêm chi tiết
                            if (response.details) {
                                resultHTML += '<h6>Chi tiết：</h6>';
                                resultHTML += '<ul class="list-group list-group-flush bg-dark">';
                                
                                // Hiển thị thông tin định dạng nhập
                                if (response.details.format) {
                                    resultHTML += '<li class="list-group-item bg-dark text-light border-secondary">';
                                    let formatDesc = 'Định dạng tiêu chuẩn';
                                    if (response.details.format === 'alist_sync_base_config') {
                                        formatDesc = 'AList-SyncĐịnh dạng cấu hình cơ bản';
                                    } else if (response.details.format === 'alist_sync_sync_config') {
                                        formatDesc = 'AList-SyncĐịnh dạng cấu hình tác vụ đồng bộ';
                                        
                                        // Hiển thị số liệu thống kê nhiệm vụ
                                        if (response.details.task_count !== undefined) {
                                            formatDesc += ` (chung${response.details.task_count}nhiệm vụ)`;
                                        }
                                        
                                        // Hiển thị liệu nó có ở định dạng cũ và mới không
                                        if (response.details.format_version) {
                                            formatDesc += ` - ${response.details.format_version}`;
                                        }
                                    }
                                    resultHTML += 'Định dạng nhập: ' + formatDesc;
                                    resultHTML += '</li>';
                                }
                                
                                // Xử lý thông tin sao lưu
                                if (response.details.backup_dir) {
                                    resultHTML += '<li class="list-group-item bg-dark text-light border-secondary">';
                                    resultHTML += 'Thư mục sao lưu: ' + response.details.backup_dir;
                                    resultHTML += '</li>';
                                }
                                
                                // Xử lý kết quả nhập dữ liệu khác nhau
                                const dataTypes = ['users', 'connections', 'tasks', 'settings'];
                                for (const type of dataTypes) {
                                    if (response.details[type]) {
                                        resultHTML += '<li class="list-group-item bg-dark text-light border-secondary">';
                                        resultHTML += type + ': ' + response.details[type];
                                        resultHTML += '</li>';
                                    }
                                }
                                
                                // Quy trình thông tin lập lịch
                                if (response.details.scheduler) {
                                    resultHTML += '<li class="list-group-item bg-dark text-light border-secondary">';
                                    resultHTML += 'Người lập lịch: ' + response.details.scheduler;
                                    resultHTML += '</li>';
                                }
                                
                                if (response.details.scheduler_error) {
                                    resultHTML += '<li class="list-group-item bg-dark text-light border-secondary text-warning">';
                                    resultHTML += 'Lỗi lập lịch: ' + response.details.scheduler_error;
                                    resultHTML += '</li>';
                                }
                                
                                resultHTML += '</ul>';
                            }
                            
                            $('#import-result-content').html(resultHTML);
                            
                            // Hiển thị kết quả hộp phương thức
                            new bootstrap.Modal(document.getElementById('import-result-modal')).show();
                            
                            // Nếu thành công，Làm mới trang
                            if (response.status === 'success') {
                                setTimeout(function() {
                                    window.location.reload();
                                }, 3000);
                            }
                        },
                        error: function(xhr) {
                            let errorMsg = 'Nhập không thành công';
                            let details = {};
                            
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMsg = response.message || errorMsg;
                                details = response.details || {};
                            } catch (e) {
                                errorMsg = 'Nhập không thành công，Lỗi máy chủ';
                            }
                            
                            // Xây dựng thông báo lỗiHTML
                            let resultHTML = '<div class="alert alert-danger mb-3">';
                            resultHTML += '<i class="bi bi-x-circle-fill me-2"></i>' + errorMsg;
                            resultHTML += '</div>';
                            
                            // Thêm chi tiết
                            if (Object.keys(details).length > 0) {
                                resultHTML += '<h6>Chi tiết lỗi：</h6>';
                                resultHTML += '<ul class="list-group list-group-flush bg-dark">';
                                for (const [key, value] of Object.entries(details)) {
                                    resultHTML += '<li class="list-group-item bg-dark text-light border-secondary">';
                                    resultHTML += key + ': ' + value;
                                    resultHTML += '</li>';
                                }
                                resultHTML += '</ul>';
                            }
                            
                            $('#import-result-content').html(resultHTML);
                            new bootstrap.Modal(document.getElementById('import-result-modal')).show();
                        },
                        complete: function() {
                            // Khôi phục trạng thái nút
                            $('#import-btn').html('<i class="bi bi-upload me-2"></i>Nhập dữ liệu');
                            $('#import-btn').prop('disabled', false);
                            
                            // Xóa đầu vào tệp
                            $('#import-file').val('');
                        }
                    });
                } catch (e) {
                    alert('Lỗi định dạng tệp，Vui lòng tải lên hợp lệJSONtài liệu');
                    $('#import-btn').html('<i class="bi bi-upload me-2"></i>Nhập dữ liệu');
                    $('#import-btn').prop('disabled', false);
                }
            };
            
            reader.onerror = function() {
                alert('Không đọc được tệp');
                $('#import-btn').html('<i class="bi bi-upload me-2"></i>Nhập dữ liệu');
                $('#import-btn').prop('disabled', false);
            };
            
            reader.readAsText(file);
        });
    });
</script>
{% endblock %} 