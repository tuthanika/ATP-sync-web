{% extends "base.html" %}

{% block title %}Quản lý tác vụ - Alist-Sync{% endblock %}

{% block page_title %}Quản lý tác vụ đồng bộ{% endblock %}

{% block styles %}
<style>
    .task-row {
        cursor: pointer;
        transition: background-color 0.2s;
        position: relative;
    }
    
    .task-row:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    .task-row:hover:after {
        content: "Bấm để xem chi tiết";
        position: absolute;
        right: 150px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0.8;
    }
    
    .active-task-row {
        background-color: rgba(13, 110, 253, 0.2) !important;
    }
    
    .task-detail-row {
        background-color: rgba(0, 0, 0, 0.2);
    }
    
    .task-detail-row .card {
        border-left: 4px solid #0d6efd;
    }
    
    /* Thêm một chỉ báo mở rộng */
    .task-row td:first-child::before {
        content: "▶";
        color: #6c757d;
        margin-right: 6px;
        display: inline-block;
        transition: transform 0.2s;
    }
    
    .active-task-row td:first-child::before {
        content: "▼";
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block header_buttons %}
<!-- Xóa nút Thêm tác vụ -->
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card bg-white shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Danh sách tác vụ</h5>
                <div>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-lg"></i> Thêm tác vụ
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 task-list-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th class="task-name-column">Tên tác vụ</th>
                                <th>Kết nối nguồn</th>
                                <th>Kết nối mục tiêu</th>
                                <th>Chế độ đồng bộ</th>
                                <th>Thời gian tạo</th>
                                <th>Lần chạy cuối cùng</th>
                                <th>Chạy lần sau</th>
                                <th>tình trạng</th>
                                <th>vận hành</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table">
                            {% if tasks %}
                                {% for task in tasks %}
                                <tr class="task-row" data-task-id="{{ task.id }}">
                                    <td>{{ task.id }}</td>
                                    <td>{{ task.name }}</td>
                                    <td>{{ task.source_connection_name }}</td>
                                    <td>{{ task.target_connection_names }}</td>
                                    <td>
                                        {% if task.sync_type == 'file_sync' %}
                                        <span class="badge bg-info">Đồng bộ hóa tệp</span>
                                        {% elif task.sync_type == 'file_move' %}
                                        <span class="badge bg-primary">Di chuyển tập tin</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ task.created_at }}</td>
                                    <td>{{ task.last_run or "Không bao giờ" }}</td>
                                    <td>{{ task.next_run or "Không có kế hoạch" }}</td>
                                    <td>
                                        {% if task.status == 'running' %}
                                        <span class="badge bg-primary">Đang chạy</span>
                                        {% elif task.status == 'completed' %}
                                        <span class="badge bg-success">Hoàn thành</span>
                                        {% elif task.status == 'failed' %}
                                        <span class="badge bg-danger">thất bại</span>
                                        {% elif task.status == 'pending' %}
                                        <span class="badge bg-secondary">Chờ</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary run-task" data-task-id="{{ task.id }}">
                                                <i class="bi bi-play-fill"></i>
                                            </button>
                                            <button class="btn btn-sm btn-info edit-task" data-task-id="{{ task.id }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-task" data-task-id="{{ task.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                            <button class="btn btn-sm btn-secondary view-instances" data-task-id="{{ task.id }}" data-task-name="{{ task.name }}">
                                                <i class="bi bi-list-ul"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="task-detail-row" id="task-detail-{{ task.id }}" style="display: none;">
                                    <td colspan="10">
                                        <div class="card tech-card mb-0">
                                            <div class="card-body">
                                                <h5 class="card-title">Chi tiết tác vụ</h5>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-2">
                                                            <strong>Đường dẫn nguồn:</strong> {{ task.source_path }}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Đường dẫn mục tiêu:</strong> {{ task.target_path }}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Chế độ đồng bộ:</strong> 
                                                            {% if task.sync_type == 'file_sync' %}Đồng bộ hóa tệp
                                                            {% elif task.sync_type == 'file_move' %}Di chuyển tập tin
                                                            {% endif %}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Chính sách xử lý khác biệt:</strong> 
                                                            {% if task.sync_diff_action == 'none' %}Không được xử lý
                                                            {% elif task.sync_diff_action == 'move' %}Di chuyển đến trạm tái chế
                                                            {% elif task.sync_diff_action == 'delete' %}xóa bỏ
                                                            {% endif %}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Loại trừ thư mục:</strong> {{ task.exclude_dirs or "không có" }}
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-2">
                                                            <strong>kế hoạch:</strong> {{ task.schedule or "Thực thi thủ công" }}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Lọc tệp:</strong> {{ task.file_filter or "không có" }}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Đã bật:</strong> {{ "Cho phép" if task.enabled else "Tàn tật" }}
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>Số lượng lưu trữ mục tiêu:</strong> 
                                                            {% if task.target_connection_ids and task.target_connection_ids|length > 0 %}
                                                                {{ task.target_connection_ids|length }}
                                                            {% else %}
                                                                1
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="10" class="text-center">Chưa có tác vụ</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm hộp phương thức tác vụ -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thêm tác vụ đồng bộ hóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="addTaskModalMessages"></div>
                <form id="taskForm">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">Tên tác vụ</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="connectionSelector" class="form-label">Chọn máy chủ</label>
                        <select class="form-select" id="connectionSelector" required>
                            <option value="">Chọn máy chủ</option>
                            <!-- vượt quaJavaScriptThêm các tùy chọn kết nối -->
                        </select>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sourceConnection" class="form-label">Kết nối nguồn</label>
                            <select class="form-select" id="sourceConnection" required>
                                <option value="">Chọn Kết nối nguồn</option>
                                <!-- Tải động danh sách lưu trữ dựa trên đầu nối đã chọn -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="targetConnections" class="form-label">Kết nối mục tiêu</label>
                            <select class="form-select" id="targetConnections" multiple required>
                                <!-- Kết nối mục tiêu là đa chọn -->
                            </select>
                            <div class="form-text">Nhấn và giữCtrlCó thể chọn nhiều khóa</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sourcePath" class="form-label">Đường dẫn nguồn</label>
                            <input type="text" class="form-control" id="sourcePath" placeholder="/" required>
                        </div>
                        <div class="col-md-6">
                            <label for="targetPath" class="form-label">Đường dẫn mục tiêu</label>
                            <input type="text" class="form-control" id="targetPath" placeholder="/" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="excludeDirs" class="form-label">Loại trừ thư mục</label>
                        <input type="text" class="form-control" id="excludeDirs" placeholder="/">
                        <div class="form-text">Liên quan đến đường dẫn nguồn，Nhiều thư mục được phân tách bằng dấu phẩy tiếng Anh</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="syncType" class="form-label">Chế độ đồng bộ</label>
                        <select class="form-select" id="syncType" required>
                            <option value="file_sync">Đồng bộ hóa tệp</option>
                            <option value="file_move">Di chuyển tập tin</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="syncDiffAction" class="form-label">Chính sách xử lý khác biệt</label>
                        <select class="form-select" id="syncDiffAction">
                            <option value="none">Không xử lý sự khác biệt của thư mục đích</option>
                            <option value="move">Di chuyển đến thư mục trash của đích</option>
                            <option value="delete">Xóa khác biệt ở thư mục đích</option>
                        </select>
                        <div class="form-text">Để ý：Chọn chế độ "Di chuyển tập tin"，Chính sách xử lý mục khác biệt sẽ bị vô hiệu hóa</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="schedule" class="form-label">kế hoạch (Biểu thức Cron，Để trống để chạy thủ công)</label>
                        <input type="text" class="form-control" id="schedule" placeholder="*/30 * * * *">
                        <div class="form-text">Ví dụ：*/30 * * * * (Mọi30phút)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fileFilter" class="form-label">Lọc tệp (Biểu thức regex，Để trống để không lọc)</label>
                        <input type="text" class="form-control" id="fileFilter" placeholder="\.jpg$|\.png$">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sizeMin" class="form-label">Kích thước tệp tối thiểu (Byte, Không bắt buộc)</label>
                            <input type="number" class="form-control" id="sizeMin" min="0" placeholder="Chỉ chuyển các tệp lớn hơn kích thước này">
                        </div>
                        <div class="col-md-6">
                            <label for="sizeMax" class="form-label">Kích thước tệp tối đa (Byte, Không bắt buộc)</label>
                            <input type="number" class="form-control" id="sizeMax" min="0" placeholder="Chỉ chuyển các tệp nhỏ hơn kích thước này">
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="taskEnabled" checked>
                        <label class="form-check-label" for="taskEnabled">Bật tác vụ</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" id="saveTaskBtn">Lưu tác vụ</button>
            </div>
        </div>
    </div>
</div>

<!-- Chỉnh sửa hộp phương thức tác vụ -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chỉnh sửa các tác vụ đồng bộ hóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editTaskModalMessages"></div>
                <form id="editTaskForm">
                    <input type="hidden" id="editTaskId">
                    <div class="mb-3">
                        <label for="editTaskName" class="form-label">Tên tác vụ</label>
                        <input type="text" class="form-control" id="editTaskName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editConnectionSelector" class="form-label">Chọn máy chủ</label>
                        <select class="form-select" id="editConnectionSelector" required>
                            <option value="">Chọn máy chủ</option>
                            <!-- vượt quaJavaScriptThêm các tùy chọn kết nối -->
                        </select>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editSourceConnection" class="form-label">Kết nối nguồn</label>
                            <select class="form-select" id="editSourceConnection" required>
                                <option value="">Chọn Kết nối nguồn</option>
                                <!-- Tải động danh sách lưu trữ dựa trên đầu nối đã chọn -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editTargetConnections" class="form-label">Kết nối mục tiêu</label>
                            <select class="form-select" id="editTargetConnections" multiple required>
                                <!-- Kết nối mục tiêu là đa chọn -->
                            </select>
                            <div class="form-text">Nhấn và giữCtrlCó thể chọn nhiều khóa</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editSourcePath" class="form-label">Đường dẫn nguồn</label>
                            <input type="text" class="form-control" id="editSourcePath" placeholder="/" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editTargetPath" class="form-label">Đường dẫn mục tiêu</label>
                            <input type="text" class="form-control" id="editTargetPath" placeholder="/" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editExcludeDirs" class="form-label">Loại trừ thư mục</label>
                        <input type="text" class="form-control" id="editExcludeDirs" placeholder="/">
                        <div class="form-text">Liên quan đến đường dẫn nguồn，Nhiều thư mục được phân tách bằng dấu phẩy tiếng Anh</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSyncType" class="form-label">Chế độ đồng bộ</label>
                        <select class="form-select" id="editSyncType" required>
                            <option value="file_sync">Đồng bộ hóa tệp</option>
                            <option value="file_move">Di chuyển tập tin</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSyncDiffAction" class="form-label">Chính sách xử lý khác biệt</label>
                        <select class="form-select" id="editSyncDiffAction">
                            <option value="none">Không xử lý sự khác biệt của thư mục đích</option>
                            <option value="move">Di chuyển đến thư mục trash của đích</option>
                            <option value="delete">Xóa khác biệt ở thư mục đích</option>
                        </select>
                        <div class="form-text">Để ý：Chọn chế độ "Di chuyển tập tin"，Chính sách xử lý mục khác biệt sẽ bị vô hiệu hóa</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editSchedule" class="form-label">kế hoạch (Biểu thức Cron，Để trống để chạy thủ công)</label>
                        <input type="text" class="form-control" id="editSchedule" placeholder="*/30 * * * *">
                        <div class="form-text">Ví dụ：*/30 * * * * (Mọi30phút)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editFileFilter" class="form-label">Lọc tệp (Biểu thức regex，Để trống để không lọc)</label>
                        <input type="text" class="form-control" id="editFileFilter" placeholder="\.jpg$|\.png$">
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editSizeMin" class="form-label">Kích thước tệp tối thiểu (Byte, Không bắt buộc)</label>
                            <input type="number" class="form-control" id="editSizeMin" min="0" placeholder="Chỉ chuyển các tệp lớn hơn kích thước này">
                        </div>
                        <div class="col-md-6">
                            <label for="editSizeMax" class="form-label">Kích thước tệp tối đa (Byte, Không bắt buộc)</label>
                            <input type="number" class="form-control" id="editSizeMax" min="0" placeholder="Chỉ chuyển các tệp nhỏ hơn kích thước này">
                        </div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="editTaskEnabled" checked>
                        <label class="form-check-label" for="editTaskEnabled">Bật tác vụ</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-primary" id="updateTaskBtn">Cập nhật tác vụ</button>
            </div>
        </div>
    </div>
</div>

<!-- Xác nhận hộp phương thức xóa -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc là bạn muốn xóa tác vụ này?？Hoạt động này không được khôi phục。</p>
                <input type="hidden" id="deleteTaskId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xác nhận xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Hộp mô hình danh sách phiên bản tác vụ -->
<div class="modal fade" id="taskInstancesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Danh sách thể hiện tác vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="instancesTaskName" class="mb-3"></h6>
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Thời gian bắt đầu</th>
                                <th>Thời gian kết thúc</th>
                                <th>tình trạng</th>
                                <th>vận hành</th>
                            </tr>
                        </thead>
                        <tbody id="instances-table">
                            <tr>
                                <td colspan="5" class="text-center">đang tải...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Hộp Modal Chế độ xem nhật ký tác vụ -->
<div class="modal fade" id="taskLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nhật ký thực thi tác vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="logTaskName" class="mb-3"></h6>
                <div id="logContent" class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto; white-space: pre-wrap;">
                    <pre id="task-log-content" class="mb-0" style="white-space: pre-wrap;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="refreshLogBtn">làm cho khỏe lại</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Tải trang hoàn tất，Bắt đầu khởi tạo...');
        
        // Biến toàn cầu，Được sử dụng để lưu trữ dữ liệu kết nối
        let globalConnections = [];
        
        // Tải tất cả các kết nối
        loadConnections();
        
        // Đang tải danh sách tác vụ
        console.log('Bắt đầu tải danh sách tác vụ...');
        loadTasks();
        
        // Thêm các sự kiện vào các hàng tác vụ hiện có
        console.log('Thêm sự kiện cho hàng tác vụ hiện tại...');
        attachTaskRowEvents();
        
        // Sự kiện Nút Xác nhận Binding Binding ban đầu
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const taskId = document.getElementById('deleteTaskId').value;
            deleteTask(taskId, this);
        });
        
        // Trì hoãn kiểm tra ràng buộc sự kiện dòng tác vụ
        setTimeout(function() {
            console.log('Trì hoãn kiểm tra ràng buộc sự kiện dòng tác vụ...');
            const taskRows = document.querySelectorAll('.task-row');
            if (taskRows.length > 0) {
                console.log(`Phát hiện ${taskRows.length} Một tác vụ，Sự kiện hồi phục`);
                
                // Thêm xử lý nhấp trực tiếp
                taskRows.forEach(row => {
                    // Loại bỏ các sự kiện cũ，Ngăn chặn trùng lặp
                    row.removeEventListener('click', taskRowClickHandler);
                    // Thêm một sự kiện mới
                    row.addEventListener('click', taskRowClickHandler);
                    console.log('Rebound nhấp vào sự kiện cho hàng tác vụ:', row.getAttribute('data-task-id'));
                });
            } else {
                console.log('Không phát hiện hàng tác vụ nào được phát hiện，Có thể trì hoãn tải');
            }
        }, 1000); // Chờ đợi1s
        
        // Xác định chức năng xử lý dòng tác vụ Nhấp vào chức năng
        function taskRowClickHandler(event) {
            console.log('Chức năng xử lý dòng Nhấp vào dòng tác vụ được gọi');
            
            // Nếu nút được nhấp vào，Chưa được xử lý để mở rộng/Đóng
            if (event.target.tagName === 'BUTTON' || 
                event.target.closest('button') || 
                event.target.tagName === 'I' ||
                event.target.closest('.btn-group')) {
                console.log('Nhấp vào khu vực nút，Bỏ qua mở rộng/Đóng');
                return;
            }
            
            // Nhận một tác vụ ID
            const taskId = this.getAttribute('data-task-id');
            console.log('Nhấp vào dòng tác vụ:', taskId);
            const detailRow = document.getElementById(`task-detail-${taskId}`);
            
            if (!detailRow) {
                console.error(`Không tìm thấy chi tiết task-detail-${taskId}`);
                return;
            }
            
            // Chuyển đổi trạng thái hiển thị của dòng chi tiết
            if (detailRow.style.display === 'none' || !detailRow.style.display) {
                // Đóng các dòng chi tiết mở khác
                document.querySelectorAll('.task-detail-row').forEach(row => {
                    if (row.id !== `task-detail-${taskId}`) {
                        row.style.display = 'none';
                        // Xóa các lớp hoạt động khỏi các hàng khác
                        const otherId = row.id.replace('task-detail-', '');
                        const otherRow = document.querySelector(`.task-row[data-task-id="${otherId}"]`);
                        if (otherRow) otherRow.classList.remove('active-task-row');
                    }
                });
                
                // Hiển thị dòng chi tiết hiện tại
                detailRow.style.display = 'table-row';
                this.classList.add('active-task-row');
            } else {
                // Ẩn dòng chi tiết hiện tại
                detailRow.style.display = 'none';
                this.classList.remove('active-task-row');
            }
        }
        
        // Khởi tạo chế độ đồng bộ hóa kiểm tra，Vô hiệu hóa Chính sách xử lý mục khác biệt nếu cần thiết
        function initSyncTypeHandling() {
            // Kiểm tra biểu mẫu thêm tác vụ
            const syncType = document.getElementById('syncType');
            if (syncType.value === 'file_move') {
                const syncDiffAction = document.getElementById('syncDiffAction');
                syncDiffAction.value = 'none';
                syncDiffAction.disabled = true;
                syncDiffAction.parentElement.querySelector('.form-text').textContent = 'Để ý："Di chuyển tập tin"Trong chế độ，Chính sách xử lý mục khác biệt đã bị vô hiệu hóa';
            }
            
            // Kiểm tra biểu mẫu tác vụ chỉnh sửa
            const editSyncType = document.getElementById('editSyncType');
            if (editSyncType.value === 'file_move') {
                const editSyncDiffAction = document.getElementById('editSyncDiffAction');
                editSyncDiffAction.value = 'none';
                editSyncDiffAction.disabled = true;
                editSyncDiffAction.parentElement.querySelector('.form-text').textContent = 'Để ý："Di chuyển tập tin"Trong chế độ，Chính sách xử lý mục khác biệt đã bị vô hiệu hóa';
            }
        }
        
        // Kiểm tra ban đầu
        initSyncTypeHandling();
        
        // Nghe hộp phương thức để mở các sự kiện，Đảm bảo trạng thái là chính xác
        document.getElementById('addTaskModal').addEventListener('show.bs.modal', initSyncTypeHandling);
        document.getElementById('editTaskModal').addEventListener('show.bs.modal', initSyncTypeHandling);
        
        // Sự kiện thay đổi bộ chọn kết nối
        document.getElementById('connectionSelector').addEventListener('change', function() {
            const connId = this.value;
            if (connId) {
                loadStorages(connId);
            } else {
                // Xóa danh sách lưu trữ
                document.getElementById('sourceConnection').innerHTML = '<option value="">Chọn Kết nối nguồn</option>';
                document.getElementById('targetConnections').innerHTML = '';
            }
        });
        
        // Chỉnh sửa sự kiện thay đổi bộ chọn kết nối chế độ chỉnh sửa
        document.getElementById('editConnectionSelector').addEventListener('change', function() {
            const connId = this.value;
            if (connId) {
                loadStoragesForEdit(connId);
            } else {
                // Xóa danh sách lưu trữ
                document.getElementById('editSourceConnection').innerHTML = '<option value="">Chọn Kết nối nguồn</option>';
                document.getElementById('editTargetConnections').innerHTML = '';
            }
        });
        
        // Xem nút thể hiện tác vụ
        document.querySelectorAll('.view-instances').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                const taskName = this.getAttribute('data-task-name');
                
                // Hiển thị tên tác vụ
                document.getElementById('instancesTaskName').textContent = `tác vụ: ${taskName} (ID: ${taskId})`;
                
                // Đang tải danh sách thể hiện tác vụ
                loadTaskInstances(taskId);
                
                // Hiển thị hộp phương thức
                new bootstrap.Modal(document.getElementById('taskInstancesModal')).show();
            });
        });
        
        // Nút làm mới nhật ký tác vụ
        document.getElementById('refreshLogBtn').addEventListener('click', function() {
            const instanceId = this.getAttribute('data-instance-id');
            if (instanceId) {
                loadTaskLog(instanceId);
            }
        });
        
        // Chỉnh sửa logic thay đổi chế độ đồng bộ trong biểu mẫu
        document.getElementById('editSyncType').addEventListener('change', function() {
            const editSyncDiffAction = document.getElementById('editSyncDiffAction');
            if (this.value === 'file_move') {
                editSyncDiffAction.value = 'none';
                editSyncDiffAction.disabled = true;
                editSyncDiffAction.parentElement.querySelector('.form-text').textContent = 'Để ý："Di chuyển tập tin"Trong chế độ，Chính sách xử lý mục khác biệt đã bị vô hiệu hóa';
            } else {
                editSyncDiffAction.disabled = false;
                editSyncDiffAction.parentElement.querySelector('.form-text').textContent = 'Để ý：Chọn chế độ "Di chuyển tập tin"，Chính sách xử lý mục khác biệt sẽ bị vô hiệu hóa';
            }
        });
        
        // Thêm logic thay đổi mẫu đồng bộ hóa ở dạng tác vụ
        document.getElementById('syncType').addEventListener('change', function() {
            const syncDiffAction = document.getElementById('syncDiffAction');
            if (this.value === 'file_move') {
                syncDiffAction.value = 'none';
                syncDiffAction.disabled = true;
                syncDiffAction.parentElement.querySelector('.form-text').textContent = 'Để ý："Di chuyển tập tin"Trong chế độ，Chính sách xử lý mục khác biệt đã bị vô hiệu hóa';
            } else {
                syncDiffAction.disabled = false;
                syncDiffAction.parentElement.querySelector('.form-text').textContent = 'Để ý：Chọn chế độ "Di chuyển tập tin"，Chính sách xử lý mục khác biệt sẽ bị vô hiệu hóa';
            }
        });
        
        // Lưu nút tác vụ
        document.getElementById('saveTaskBtn').addEventListener('click', function() {
            console.log('Nút Save Task được nhấp vào');
            
            // Xác minh các trường bắt buộc
            const taskName = document.getElementById('taskName');
            if (!taskName.value.trim()) {
                showAddTaskMessage('Vui lòng nhập tên tác vụ', 'warning');
                taskName.focus();
                console.log('Xác minh thất bại：Tên tác vụ trống');
                return;
            }
            
            // Nhận kết nối nguồn và đích được chọn
            const sourceConn = document.getElementById('sourceConnection');
            const targetConns = [];
            document.querySelectorAll('#targetConnections option:checked').forEach(option => {
                targetConns.push(option.value);
            });
            
            if (!sourceConn.value) {
                showAddTaskMessage('Vui lòng chọn kết nối nguồn', 'warning');
                sourceConn.focus();
                console.log('Xác minh thất bại：Kết nối nguồn không được chọn');
                return;
            }
            
            if (targetConns.length === 0) {
                showAddTaskMessage('Vui lòng chọn ít nhất một kết nối đích', 'warning');
                document.getElementById('targetConnections').focus();
                console.log('Xác minh thất bại：Kết nối mục tiêu không được chọn');
                return;
            }
            
            // Tắt nút，Hiển thị trạng thái tải
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Tiết kiệm...';
            console.log('Nút bị tắt，Hiển thị trạng thái tải');
            
            // Chuẩn bị dữ liệu biểu mẫu
            const taskData = {
                name: taskName.value,
                connection_id: document.getElementById('connectionSelector').value || 1,
                source_connection_id: sourceConn.value,
                source_connection_name: sourceConn.options[sourceConn.selectedIndex].text,
                target_connection_ids: targetConns,
                target_connection_names: Array.from(document.querySelectorAll('#targetConnections option:checked')).map(opt => opt.text).join(', '),
                source_path: document.getElementById('sourcePath').value,
                target_path: document.getElementById('targetPath').value,
                exclude_dirs: document.getElementById('excludeDirs').value,
                sync_type: document.getElementById('syncType').value,
                sync_diff_action: document.getElementById('syncDiffAction').value,
                schedule: document.getElementById('schedule').value,
                file_filter: document.getElementById('fileFilter').value,
                size_min: document.getElementById('sizeMin').value ? parseInt(document.getElementById('sizeMin').value) : null,
                size_max: document.getElementById('sizeMax').value ? parseInt(document.getElementById('sizeMax').value) : null,
                enabled: document.getElementById('taskEnabled').checked
            };
            
            console.log('Chuẩn bị để lưu dữ liệu tác vụ:', taskData);
            
            // Nếu không có đầu nối được chọn，Tự động sử dụng kết nối đầu tiênID
            if (!taskData.connection_id && globalConnections && globalConnections.length > 0) {
                taskData.connection_id = globalConnections[0].connection_id;
                console.log('Trình kết nối không được chọn，Tự động sử dụng kết nối đầu tiênID:', taskData.connection_id);
            }
            
            // gửiAJAXYêu cầu lưu tác vụ
            console.log('Bắt đầu gửiAJAXhỏi');
            fetch('/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData),
            })
            .then(response => {
                console.log('nhận đượcAJAXphản ứng:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`Lỗi phản hồi mạng: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Phân tích dữ liệu phản hồi phân tích:', data);
                if (data.status === 'success') {
                    showAlert('Bổ sung tác vụ đã thành công', 'success');
                    // Đóng hộp phương thức - sử dụngBootstrap 5Đóng đường
                    const modalElement = document.getElementById('addTaskModal');
                    console.log('Nhận phần tử hộp phương thức:', modalElement);
                    
                    try {
                        const bsModal = bootstrap.Modal.getOrCreateInstance(modalElement);
                        console.log('sử dụnggetOrCreateInstanceNhận một thể hiện hộp phương thức:', bsModal);
                        bsModal.hide();
                        console.log('Hộp phương thức được đóng lại');
                    } catch (modalError) {
                        console.error('Xảy ra lỗi trong khi đóng hộp phương thức:', modalError);
                    }
                    // Làm mới danh sách tác vụ thay vì toàn bộ trang
                    loadTasks();
                    
                    // Tải lại Lập lịch để cập nhật lịch trình tác vụ
                    setTimeout(() => {
                        fetch('/api/scheduler/reload', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(result => {
                            console.log('Bộ lập lịch đã được tải lại:', result);
                            // Làm mới lại sau khi tải lại bộ lập lịch，Đảm bảo thời gian chạy tiếp theo được cập nhật
                            setTimeout(() => {
                                loadTasks();
                            }, 1000);
                        })
                        .catch(err => {
                            console.error('Bộ lập lịch tải lại không thành công:', err);
                        });
                    }, 500);
                } else {
                    throw new Error(data.message || 'Tiết kiệm thất bại');
                }
            })
            .catch(error => {
                console.error('Lưu tác vụ không thành công:', error);
                showAlert('Lưu tác vụ không thành công: ' + error.message, 'danger');
                
                // Hiển thị thêm thông báo lỗi trên bảng điều khiển
                console.log('Vui lòng kiểm tra bảng điều khiển để biết thông báo lỗi hoàn chỉnh và yêu cầu mạng');
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                this.disabled = false;
                this.innerHTML = 'Lưu tác vụ';
                console.log('Trạng thái nút đã được khôi phục');
            });
        });
        
        // Chỉnh sửa nút tác vụ
        document.querySelectorAll('.edit-task').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                
                // Hiển thị trạng thái tải
                this.disabled = true;
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                
                // vượt quaAPINhận thông tin tác vụ
                fetch(`/api/tasks/${taskId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không lấy được thông tin tác vụ');
                    }
                    return response.json();
                })
                .then(task => {
                    // Dữ liệu tác vụ đầu ra gỡ lỗi
                    console.log('Thu được dữ liệu tác vụ:', task);
                    
                    // Điền vào biểu mẫu
                    document.getElementById('editTaskId').value = task.id;
                    document.getElementById('editTaskName').value = task.name;
                    
                    // Cho đầu nối，Cần có một kết nối cụ thểID
                    // hiện hữutask.jsonThường không được lưu trực tiếp vàoconnection_id，Cần trích xuất từ thông tin kết nối nguồn
                    
                    // Đặt đường dẫn nguồn và đường dẫn đích
                    document.getElementById('editSourcePath').value = task.source_path || '/';
                    document.getElementById('editTargetPath').value = task.target_path || '/';
                    document.getElementById('editSyncType').value = task.sync_type || 'file_sync';
                    document.getElementById('editSyncDiffAction').value = task.sync_diff_action || 'none';
                    document.getElementById('editSchedule').value = task.schedule || '';
                    document.getElementById('editFileFilter').value = task.file_filter || '';
                    // Mới：Tối thiểu/Kích thước tệp tối đa
                    document.getElementById('editSizeMin').value = task.size_min != null ? task.size_min : '';
                    document.getElementById('editSizeMax').value = task.size_max != null ? task.size_max : '';
                    document.getElementById('editExcludeDirs').value = task.exclude_dirs || '';
                    document.getElementById('editTaskEnabled').checked = task.enabled !== false;
                    
                    // Tải tất cả các kết nối đầu tiên，Sau đó chọn kết nối được sử dụng bởi tác vụ và tải Danh sách lưu trữ
                    loadConnectionsForEdit(task);
                    
                    // Hiển thị hộp Modal EDIT
                    new bootstrap.Modal(document.getElementById('editTaskModal')).show();
                })
                .catch(error => {
                    console.error('Không lấy được thông tin tác vụ:', error);
                    showAlert('Không lấy được thông tin tác vụ: ' + error.message, 'danger');
                })
                .finally(() => {
                    // Khôi phục trạng thái nút
                    this.disabled = false;
                    this.innerHTML = originalHTML;
                });
            });
        });
        
        // Cập nhật nút tác vụ
        document.getElementById('updateTaskBtn').addEventListener('click', function() {
            // Xác minh các trường bắt buộc
            const editTaskName = document.getElementById('editTaskName');
            if (!editTaskName.value.trim()) {
                showEditMessage('Vui lòng nhập tên tác vụ', 'warning');
                editTaskName.focus();
                return;
            }
            
            // Nhận một tác vụ ID
            const taskId = document.getElementById('editTaskId').value;
            
            // Tắt nút，Hiển thị trạng thái tải
            this.disabled = true;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Cập nhật...';
            
            // Nhận kết nối nguồn và đích được chọn
            const sourceConn = document.getElementById('editSourceConnection');
            const targetConns = [];
            document.querySelectorAll('#editTargetConnections option:checked').forEach(option => {
                targetConns.push(option.value);
            });
            
            if (!sourceConn.value) {
                showEditMessage('Vui lòng chọn kết nối nguồn', 'warning');
                sourceConn.focus();
                return;
            }
            
            if (targetConns.length === 0) {
                showEditMessage('Vui lòng chọn ít nhất một kết nối đích', 'warning');
                document.getElementById('editTargetConnections').focus();
                return;
            }
            
            // Chuẩn bị dữ liệu biểu mẫu
            const taskData = {
                name: editTaskName.value,
                connection_id: document.getElementById('editConnectionSelector').value || 1,
                source_connection_id: sourceConn.value,
                source_connection_name: sourceConn.options[sourceConn.selectedIndex].text,
                target_connection_ids: targetConns,
                target_connection_names: Array.from(document.querySelectorAll('#editTargetConnections option:checked')).map(opt => opt.text).join(', '),
                source_path: document.getElementById('editSourcePath').value,
                target_path: document.getElementById('editTargetPath').value,
                exclude_dirs: document.getElementById('editExcludeDirs').value,
                sync_type: document.getElementById('editSyncType').value,
                sync_diff_action: document.getElementById('editSyncDiffAction').value,
                schedule: document.getElementById('editSchedule').value,
                file_filter: document.getElementById('editFileFilter').value,
                size_min: document.getElementById('editSizeMin').value ? parseInt(document.getElementById('editSizeMin').value) : null,
                size_max: document.getElementById('editSizeMax').value ? parseInt(document.getElementById('editSizeMax').value) : null,
                enabled: document.getElementById('editTaskEnabled').checked
            };
            
            console.log('Chuẩn bị cập nhật dữ liệu tác vụ:', taskData);
            
            // Nếu không có đầu nối được chọn，Tự động sử dụng kết nối đầu tiênID
            if (!taskData.connection_id && globalConnections && globalConnections.length > 0) {
                taskData.connection_id = globalConnections[0].connection_id;
                console.log('Trình kết nối không được chọn，Tự động sử dụng kết nối đầu tiênID:', taskData.connection_id);
            }
            
            // gửiAJAXYêu cầu cập nhật tác vụ
            fetch(`/api/tasks/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(taskData),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi phản hồi mạng');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    showAlert(taskId ? 'Cập nhật tác vụ thành công' : 'Sáng tạo tác vụ thành công', 'success');
                    // Đóng hộp phương thức và làm mới danh sách tác vụ
                    const modalElement = document.getElementById('editTaskModal');
                    console.log('Nhận phần tử hộp chỉnh sửa phần tử:', modalElement);
                    
                    try {
                        const bsModal = bootstrap.Modal.getOrCreateInstance(modalElement);
                        console.log('sử dụnggetOrCreateInstanceNhận phiên bản Modal Box Chỉnh sửa:', bsModal);
                        bsModal.hide();
                        console.log('Chỉnh sửa hộp phương thức được đóng');
                    } catch (modalError) {
                        console.error('Xảy ra lỗi trong khi đóng hộp chỉnh sửa phương thức:', modalError);
                    }
                    loadTasks();
                    
                    // Tải lại Lập lịch để cập nhật lịch trình tác vụ
                    setTimeout(() => {
                        fetch('/api/scheduler/reload', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(result => {
                            console.log('Bộ lập lịch đã được tải lại:', result);
                            // Làm mới lại sau khi tải lại bộ lập lịch，Đảm bảo thời gian chạy tiếp theo được cập nhật
                            setTimeout(() => {
                                loadTasks();
                            }, 1000);
                        })
                        .catch(err => {
                            console.error('Bộ lập lịch tải lại không thành công:', err);
                        });
                    }, 500);
                } else {
                    showAlert(data.message || 'Lưu tác vụ không thành công', 'danger');
                }
            })
            .catch(error => {
                console.error('Cập nhật tác vụ không thành công:', error);
                showAlert('Cập nhật tác vụ không thành công: ' + error.message, 'danger');
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                this.disabled = false;
                this.innerHTML = originalHTML;
            });
        });
        
        // Xóa sự kiện nút
        document.querySelectorAll('.delete-task').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                document.getElementById('deleteTaskId').value = taskId;
                
                // Chức năng xử lý sự kiện phục hồi của nút Xóa xác nhận
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                // Loại bỏ một trình nghe sự kiện có thể đã tồn tại trước đó
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // Thêm trình nghe sự kiện cho các nút mới
                newConfirmBtn.addEventListener('click', function() {
                    deleteTask(taskId, this);
                });
                
                new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
            });
        });
        
        // Chạy nút tác vụ
        document.querySelectorAll('.run-task').forEach(button => {
            button.addEventListener('click', function() {
                const taskId = this.getAttribute('data-task-id');
                
                // Hiển thị trạng thái tải
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                this.disabled = true;
                
                // gửiAJAXYêu cầu chạy một tác vụ
                fetch(`/api/tasks/${taskId}/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Lỗi phản hồi mạng');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // Hiển thị kết quả chạy tác vụ
                        if (data.instance_id) {
                            // Nếu thể hiện được trả lạiID，Nhắc xem nhật ký
                            const result = confirm(`tác vụ ${taskId} Bắt đầu chạy，Có xem nhật ký thực thi hay không？`);
                            if (result) {
                                // Hiển thị tên tác vụ
                                const taskName = this.closest('tr').querySelector('td:nth-child(2)').textContent;
                                document.getElementById('logTaskName').textContent = `tác vụ: ${taskName} (Task ID: ${data.instance_id})`;
                                
                                // Đặt một phiên bản của nút làm mớiID
                                document.getElementById('refreshLogBtn').setAttribute('data-instance-id', data.instance_id);
                                
                                // Tải nhật ký tác vụ
                                loadTaskLog(data.instance_id);
                                
                                // Hiển thị hộp Modal nhật ký
                                new bootstrap.Modal(document.getElementById('taskLogModal')).show();
                            }
                        } else {
                            showAlert(`tác vụ ${taskId} Bắt đầu chạy`, 'success');
                        }
                        // Làm mới danh sách tác vụ thay vì toàn bộ trang
                        loadTasks();
                        
                        // Tải lại Lập lịch để cập nhật lịch trình tác vụ
                        setTimeout(() => {
                            fetch('/api/scheduler/reload', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(result => {
                                console.log('Bộ lập lịch đã được tải lại:', result);
                                // Làm mới lại sau khi tải lại bộ lập lịch，Đảm bảo thời gian chạy tiếp theo được cập nhật
                                setTimeout(() => {
                                    loadTasks();
                                }, 1000);
                            })
                            .catch(err => {
                                console.error('Bộ lập lịch tải lại không thành công:', err);
                            });
                        }, 500);
                    } else {
                        throw new Error(data.message || 'Chạy không thành công');
                    }
                })
                .catch(error => {
                    console.error('Không chạy tác vụ:', error);
                    showAlert('Không chạy tác vụ: ' + error.message, 'danger');
                })
                .finally(() => {
                    // Khôi phục trạng thái nút
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                });
            });
        });
        
        // Chức năng trợ giúp：Tải tất cả các kết nối
        function loadConnections() {
            fetch('/api/connections')
            .then(response => response.json())
            .then(connections => {
                // Lưu trữ dữ liệu kết nối đến các biến toàn cầu
                globalConnections = connections;
                
                const connectionSelector = document.getElementById('connectionSelector');
                connectionSelector.innerHTML = '<option value="">Chọn máy chủ</option>';
                
                if (connections && connections.length > 0) {
                    connections.forEach(conn => {
                        const option = document.createElement('option');
                        option.value = conn.connection_id;
                        option.textContent = conn.name;
                        connectionSelector.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Tải kết nối không thành công:', error);
                showAlert('Không tải danh sách kết nối', 'danger');
            });
        }
        
        // Chức năng trợ giúp：Tải kết nối chế độ chỉnh sửa
        function loadConnectionsForEdit(task) {
            fetch('/api/connections')
            .then(response => response.json())
            .then(connections => {
                const editConnectionSelector = document.getElementById('editConnectionSelector');
                editConnectionSelector.innerHTML = '<option value="">Chọn máy chủ</option>';
                
                if (connections && connections.length > 0) {
                    connections.forEach(conn => {
                        const option = document.createElement('option');
                        option.value = conn.connection_id;
                        option.textContent = conn.name;
                        editConnectionSelector.appendChild(option);
                    });
                    
                    // Sử dụng kết nối trong tác vụIDĐiền vào mẫu chỉnh sửa
                    // nói chung là，Đầu nối này nên có sẵn trong các tác vụ ID
                    const connId = task.connection_id || task.conn_id;
                    
                    // In dữ liệu tác vụ，Giúp gỡ lỗi
                    console.log('Dữ liệu tác vụ:', task);
                    
                    if (connId) {
                        // Thiết lập đầu nối đã chọn
                        editConnectionSelector.value = connId;
                        // Tải danh sách lưu trữ của các đầu nối
                        loadStoragesForEdit(connId, task);
                    } else {
                        console.warn('Không tìm thấy trong dữ liệu tác vụconnection_idtrường');
                        // Cố gắng tải danh sách lưu trữ từ kết nối đầu tiên
                        if (connections.length > 0) {
                            const firstConnId = connections[0].connection_id;
                            editConnectionSelector.value = firstConnId;
                            loadStoragesForEdit(firstConnId, task);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Tải kết nối không thành công:', error);
                showAlert('Không tải danh sách kết nối', 'danger');
            });
        }
        
        // Chức năng trợ giúp：Tải danh sách lưu trữ
        function loadStorages(connId) {
            // Hiển thị trạng thái tải
            document.getElementById('sourceConnection').innerHTML = '<option value="">đang tải...</option>';
            document.getElementById('targetConnections').innerHTML = '<option value="">đang tải...</option>';
            
            fetch(`/api/storages?conn_id=${connId}`)
            .then(response => response.json())
            .then(data => {
                const sourceConnection = document.getElementById('sourceConnection');
                const targetConnections = document.getElementById('targetConnections');
                
                // Đặt lại bộ chọn
                sourceConnection.innerHTML = '<option value="">Chọn Kết nối nguồn</option>';
                targetConnections.innerHTML = '';
                
                if (data.status === 'success' && data.data && data.data.length > 0) {
                    // Điền vào danh sách lưu trữ
                    data.data.forEach(storage => {
                        // Thêm  kết nối nguồn
                        const sourceOption = document.createElement('option');
                        sourceOption.value = storage.id || storage.name;
                        sourceOption.textContent = storage.name;
                        sourceConnection.appendChild(sourceOption);
                        
                        // Thêm  kết nối đích
                        const targetOption = document.createElement('option');
                        targetOption.value = storage.id || storage.name;
                        targetOption.textContent = storage.name;
                        targetConnections.appendChild(targetOption);
                    });
                } else {
                    showAlert('Không nhận được danh sách lưu trữ hoặc danh sách lưu trữ trống', 'warning');
                }
            })
            .catch(error => {
                console.error('Không tải được danh sách lưu trữ:', error);
                showAlert('Không tải được danh sách lưu trữ: ' + error.message, 'danger');
                
                // Đặt lại bộ chọn
                document.getElementById('sourceConnection').innerHTML = '<option value="">Chọn Kết nối nguồn</option>';
                document.getElementById('targetConnections').innerHTML = '';
            });
        }
        
        // Chức năng trợ giúp：Tải danh sách lưu trữ của chế độ chỉnh sửa
        function loadStoragesForEdit(connId, task = null) {
            // Hiển thị trạng thái tải
            document.getElementById('editSourceConnection').innerHTML = '<option value="">đang tải...</option>';
            document.getElementById('editTargetConnections').innerHTML = '<option value="">đang tải...</option>';
            
            fetch(`/api/storages?conn_id=${connId}`)
            .then(response => response.json())
            .then(data => {
                const editSourceConnection = document.getElementById('editSourceConnection');
                const editTargetConnections = document.getElementById('editTargetConnections');
                
                // Đặt lại bộ chọn
                editSourceConnection.innerHTML = '<option value="">Chọn Kết nối nguồn</option>';
                editTargetConnections.innerHTML = '';
                
                if (data.status === 'success' && data.data && data.data.length > 0) {
                    // Điền vào danh sách lưu trữ
                    data.data.forEach(storage => {
                        // Thêm  kết nối nguồn
                        const sourceOption = document.createElement('option');
                        sourceOption.value = storage.id || storage.name;
                        sourceOption.textContent = storage.name;
                        editSourceConnection.appendChild(sourceOption);
                        
                        // Thêm  kết nối đích
                        const targetOption = document.createElement('option');
                        targetOption.value = storage.id || storage.name;
                        targetOption.textContent = storage.name;
                        editTargetConnections.appendChild(targetOption);
                    });
                    
                    // Nếu có dữ liệu tác vụ，Đặt giá trị đã chọn
                    if (task) {
                        console.log('Các kết nối nguồn và mục tiêu là nguồn:', task);
                        
                        // Thiết lập kết nối nguồn
                        if (task.source_connection_id) {
                            console.log('Thiết lập kết nối nguồn:', task.source_connection_id);
                            editSourceConnection.value = task.source_connection_id;
                        }
                        
                        // Thiết lập kết nối mục tiêu（Nhiều lựa chọn）
                        if (task.target_connection_ids && Array.isArray(task.target_connection_ids)) {
                            console.log('Thiết lập kết nối mục tiêu:', task.target_connection_ids);
                            // Bởi vì nó làselect multiple，Cần được đặt từng cái mộtoptioncủaselectedtài sản
                            Array.from(editTargetConnections.options).forEach(option => {
                                option.selected = task.target_connection_ids.includes(option.value);
                            });
                        }
                    }
                } else {
                    console.error('Không nhận được danh sách lưu trữ hoặc trống:', data);
                    showAlert('Không nhận được danh sách lưu trữ hoặc danh sách lưu trữ trống', 'warning');
                }
            })
            .catch(error => {
                console.error('Không tải được danh sách lưu trữ:', error);
                showAlert('Không tải được danh sách lưu trữ: ' + error.message, 'danger');
                
                // Đặt lại bộ chọn
                document.getElementById('editSourceConnection').innerHTML = '<option value="">Chọn Kết nối nguồn</option>';
                document.getElementById('editTargetConnections').innerHTML = '';
            });
        }
        
        // Chức năng trợ giúp：Đang tải danh sách thể hiện tác vụ
        function loadTaskInstances(taskId) {
            const instancesTable = document.getElementById('instances-table');
            instancesTable.innerHTML = '<tr><td colspan="5" class="text-center">đang tải...</td></tr>';
            
            fetch(`/api/task-instances?task_id=${taskId}`)
            .then(response => response.json())
            .then(instances => {
                if (instances && instances.length > 0) {
                    // Xóa hình thức
                    instancesTable.innerHTML = '';
                    
                    // Dữ liệu thể hiện
                    instances.forEach(instance => {
                        const row = document.createElement('tr');
                        
                        // Thêm thông tin thể hiện
                        row.innerHTML = `
                            <td>${instance.task_instances_id}</td>
                            <td>${instance.start_time_formatted}</td>
                            <td>${instance.end_time_formatted || 'Đang tiến hành'}</td>
                            <td>
                                ${getStatusBadge(instance.status)}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info view-log" data-instance-id="${instance.task_instances_id}" data-task-name="${instance.task_name}">
                                    <i class="bi bi-file-text"></i> Xem nhật ký
                                </button>
                            </td>
                        `;
                        
                        instancesTable.appendChild(row);
                    });
                    
                    // Thêm một sự kiện ghi xem Chế độ xem
                    document.querySelectorAll('.view-log').forEach(button => {
                        button.addEventListener('click', function() {
                            const instanceId = this.getAttribute('data-instance-id');
                            const taskName = this.getAttribute('data-task-name');
                            
                            // Hiển thị tên tác vụ
                            document.getElementById('logTaskName').textContent = `tác vụ: ${taskName} (Task ID: ${instanceId})`;
                            
                            // Đặt một phiên bản của nút làm mớiID
                            document.getElementById('refreshLogBtn').setAttribute('data-instance-id', instanceId);
                            
                            // Tải nhật ký tác vụ
                            loadTaskLog(instanceId);
                            
                            // Hiển thị hộp Modal nhật ký
                            new bootstrap.Modal(document.getElementById('taskLogModal')).show();
                        });
                    });
                } else {
                    instancesTable.innerHTML = '<tr><td colspan="5" class="text-center">Chưa có bản ghi phiên bản nào</td></tr>';
                }
            })
            .catch(error => {
                console.error('Không tải được thể hiện tác vụ:', error);
                instancesTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Tải không thành công: ' + error.message + '</td></tr>';
            });
        }
        
        // Chức năng trợ giúp：Tải nhật ký tác vụ
        function loadTaskLog(instanceId) {
            const logContent = document.getElementById('logContent');
            const logContentPre = document.getElementById('task-log-content');
            
            // Hiển thị trạng thái tải - TheoDOMChọn đúng phần tử trong cấu trúc
            if (logContentPre) {
                logContentPre.textContent = 'đang tải...';
            } else {
                logContent.textContent = 'đang tải...';
            }
            
            fetch(`/api/task-instances/${instanceId}/logs`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.logs && data.logs.length > 0) {
                    const logText = data.logs.join('\n');
                    if (logContentPre) {
                        logContentPre.textContent = logText;
                    } else {
                        logContent.textContent = logText;
                    }
                } else {
                    const emptyText = 'Không tìm thấy ghi nhật ký';
                    if (logContentPre) {
                        logContentPre.textContent = emptyText;
                    } else {
                        logContent.textContent = emptyText;
                    }
                }
            })
            .catch(error => {
                console.error('Không tải được nhật ký tác vụ:', error);
                const errorText = 'Không tải được nhật ký: ' + error.message;
                if (logContentPre) {
                    logContentPre.textContent = errorText;
                } else {
                    logContent.textContent = errorText;
                }
            });
        }
        
        // Chức năng trợ giúp：Nhận huy hiệu trạng tháiHTML
        function getStatusBadge(status) {
            switch (status) {
                case 'running':
                    return '<span class="badge bg-primary">Đang chạy</span>';
                case 'completed':
                    return '<span class="badge bg-success">Hoàn thành</span>';
                case 'failed':
                    return '<span class="badge bg-danger">thất bại</span>';
                default:
                    return '<span class="badge bg-secondary">không xác định</span>';
            }
        }
        
        // Chức năng trợ giúp：Hiển thị thông báo trong hộp Chế độ tác vụ Thêm
        function showAddTaskMessage(message, type = 'warning') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
            messageDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Nhận thùng chứa thông báo để thêm hộp phương thức
            const messageContainer = document.getElementById('addTaskModalMessages') || document.querySelector('#addTaskModal .modal-body');
            
            // Xóa các tin nhắn hiện có
            const existingMessages = messageContainer.querySelectorAll('.alert');
            existingMessages.forEach(msg => msg.remove());
            
            // Thêm thông báo mới vào đầu của container
            messageContainer.insertBefore(messageDiv, messageContainer.firstChild);
            
            // 3Nó tự động biến mất trong vài giây
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 150);
            }, 3000);
        }
        
        // Chức năng trợ giúp：Hiển thị thông báo trong hộp chỉnh sửa phương thức
        function showEditMessage(message, type = 'warning') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
            messageDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Nhận hộp chứa tin nhắn để chỉnh sửa hộp phương thức
            const messageContainer = document.getElementById('editTaskModalMessages') || document.querySelector('#editTaskModal .modal-body');
            
            // Xóa các tin nhắn hiện có
            const existingMessages = messageContainer.querySelectorAll('.alert');
            existingMessages.forEach(msg => msg.remove());
            
            // Thêm thông báo mới vào đầu của container
            messageContainer.insertBefore(messageDiv, messageContainer.firstChild);
            
            // 3Nó tự động biến mất trong vài giây
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 150);
            }, 3000);
        }

        // Chức năng trợ giúp：Hiển thị lời nhắc tin nhắn toàn cầu
        function showAlert(message, type = 'info') {
            // Tạo một container cảnh báo
            const alertContainer = document.createElement('div');
            alertContainer.className = 'position-fixed top-0 end-0 p-3';
            alertContainer.style.zIndex = '9999';
            
            // Tạo các yếu tố cảnh báo
            const alertEl = document.createElement('div');
            alertEl.className = `alert alert-${type} alert-dismissible fade show`;
            alertEl.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Thêm  các container và trang
            alertContainer.appendChild(alertEl);
            document.body.appendChild(alertContainer);
            
            // 3Tự động đóng trong vài giây
            setTimeout(() => {
                alertEl.classList.remove('show');
                setTimeout(() => {
                    if (alertContainer.parentNode) {
                        document.body.removeChild(alertContainer);
                    }
                }, 150);
            }, 3000);
        }
        
        // Chức năng trợ giúp：Đang tải danh sách tác vụ
        function loadTasks() {
            fetch('/api/tasks')
            .then(response => response.json())
            .then(tasks => {
                const tasksTable = document.getElementById('tasks-table');
                
                if (tasks && tasks.length > 0) {
                    // Xóa biểu mẫu và đổ đầy nó
                    tasksTable.innerHTML = '';
                    
                    // Tập hợp danh sách tác vụ với các mẫu
                    tasks.forEach(task => {
                        // Dòng chính
                        const taskRow = document.createElement('tr');
                        taskRow.className = 'task-row';
                        taskRow.setAttribute('data-task-id', task.id);
                        
                        // Đặt nội dung dòng
                        taskRow.innerHTML = `
                            <td>${task.id}</td>
                            <td>${task.name}</td>
                            <td>${task.source_connection_name || ''}</td>
                            <td>${task.target_connection_names || ''}</td>
                            <td>
                                ${task.sync_type === 'file_sync' ? '<span class="badge bg-info">Đồng bộ hóa tệp</span>' : ''}
                                ${task.sync_type === 'file_move' ? '<span class="badge bg-primary">Di chuyển tập tin</span>' : ''}
                            </td>
                            <td>${task.created_at || ''}</td>
                            <td>${task.last_run || 'Không bao giờ'}</td>
                            <td>${task.next_run || 'Không có kế hoạch'}</td>
                            <td>
                                ${task.status === 'running' ? '<span class="badge bg-primary">Đang chạy</span>' : ''}
                                ${task.status === 'completed' ? '<span class="badge bg-success">Hoàn thành</span>' : ''}
                                ${task.status === 'failed' ? '<span class="badge bg-danger">thất bại</span>' : ''}
                                ${task.status === 'pending' ? '<span class="badge bg-secondary">Chờ</span>' : ''}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-primary run-task" data-task-id="${task.id}">
                                        <i class="bi bi-play-fill"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info edit-task" data-task-id="${task.id}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-task" data-task-id="${task.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button class="btn btn-sm btn-secondary view-instances" data-task-id="${task.id}" data-task-name="${task.name}">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        // Chi tiết
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'task-detail-row';
                        detailRow.id = `task-detail-${task.id}`;
                        detailRow.style.display = 'none';
                        
                        // Văn bản Chính sách xử lý mục khác biệt
                        let diffActionText = 'Không được xử lý';
                        if (task.sync_diff_action === 'move') diffActionText = 'Di chuyển đến trạm tái chế';
                        if (task.sync_diff_action === 'delete') diffActionText = 'xóa bỏ';
                        
                        // Đặt nội dung dòng chi tiết
                        detailRow.innerHTML = `
                            <td colspan="10">
                                <div class="card tech-card mb-0">
                                    <div class="card-body">
                                        <h5 class="card-title">Chi tiết tác vụ</h5>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <strong>Đường dẫn nguồn:</strong> ${task.source_path || '/'}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Đường dẫn mục tiêu:</strong> ${task.target_path || '/'}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Chế độ đồng bộ:</strong> 
                                                    ${task.sync_type === 'file_sync' ? 'Đồng bộ hóa tệp' : ''}
                                                    ${task.sync_type === 'file_move' ? 'Di chuyển tập tin' : ''}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Chính sách xử lý khác biệt:</strong> ${diffActionText}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Loại trừ thư mục:</strong> ${task.exclude_dirs || 'không có'}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <strong>kế hoạch:</strong> ${task.schedule || 'Thực thi thủ công'}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Lọc tệp:</strong> ${task.file_filter || 'không có'}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Đã bật:</strong> ${task.enabled !== false ? 'Cho phép' : 'Tàn tật'}
                                                </div>
                                                <div class="mb-2">
                                                    <strong>Số lượng lưu trữ mục tiêu:</strong> 
                                                    ${Array.isArray(task.target_connection_ids) ? task.target_connection_ids.length : 1}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `;
                        
                        // Thêm  bảng
                        tasksTable.appendChild(taskRow);
                        tasksTable.appendChild(detailRow);
                    });
                    
                    // Thêm sự kiện cho các dòng và nút tác vụ
                    attachTaskButtonEvents();
                    console.log('hiện hữuloadTasksNhấp vào sự kiện trong dòng tác vụ liên kết');
                    
                    // Đảm bảo dòng tác vụ bị ràng buộc với sự kiện nhấp chuột
                    const taskRows = document.querySelectorAll('.task-row');
                    taskRows.forEach(row => {
                        // Loại bỏ các sự kiện cũ，Ngăn chặn trùng lặp
                        row.removeEventListener('click', taskRowClickHandler);
                        // Thêm một sự kiện mới
                        row.addEventListener('click', taskRowClickHandler);
                        console.log('hiện hữuloadTasksBINDING BLOP SỰ KIỆN CHO LINE TASK:', row.getAttribute('data-task-id'));
                    });
                } else {
                    tasksTable.innerHTML = '<tr><td colspan="10" class="text-center">Chưa có tác vụ</td></tr>';
                }
            })
            .catch(error => {
                console.error('Không tải được danh sách tác vụ:', error);
                document.getElementById('tasks-table').innerHTML = 
                    '<tr><td colspan="10" class="text-center text-danger">Không tải được danh sách tác vụ</td></tr>';
            });
        }
        
        // Liên kết các sự kiện cho các nút tác vụ mới được tải
        function attachTaskButtonEvents() {
            // Chỉnh sửa nút tác vụ
            document.querySelectorAll('.edit-task').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    
                    // Hiển thị trạng thái tải
                    this.disabled = true;
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    
                    // vượt quaAPINhận thông tin tác vụ
                    fetch(`/api/tasks/${taskId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Không lấy được thông tin tác vụ');
                        }
                        return response.json();
                    })
                    .then(task => {
                        // Dữ liệu tác vụ đầu ra gỡ lỗi
                        console.log('Thu được dữ liệu tác vụ:', task);
                        
                        // Điền vào biểu mẫu
                        document.getElementById('editTaskId').value = task.id;
                        document.getElementById('editTaskName').value = task.name;
                        
                        // Đặt đường dẫn nguồn và đường dẫn đích
                        document.getElementById('editSourcePath').value = task.source_path || '/';
                        document.getElementById('editTargetPath').value = task.target_path || '/';
                        document.getElementById('editSyncType').value = task.sync_type || 'file_sync';
                        document.getElementById('editSyncDiffAction').value = task.sync_diff_action || 'none';
                        document.getElementById('editSchedule').value = task.schedule || '';
                        document.getElementById('editFileFilter').value = task.file_filter || '';
                        
                        // Tối thiểu/Kích thước tệp tối đa
                        document.getElementById('editSizeMin').value = task.size_min != null ? task.size_min : '';
                        document.getElementById('editSizeMax').value = task.size_max != null ? task.size_max : '';
                        document.getElementById('editExcludeDirs').value = task.exclude_dirs || '';
                        document.getElementById('editTaskEnabled').checked = task.enabled !== false;
                        
                        // Tải tất cả các kết nối đầu tiên，Sau đó chọn kết nối được sử dụng bởi tác vụ và tải Danh sách lưu trữ
                        loadConnectionsForEdit(task);
                        
                        // Hiển thị hộp Modal EDIT
                        new bootstrap.Modal(document.getElementById('editTaskModal')).show();
                    })
                    .catch(error => {
                        console.error('Không lấy được thông tin tác vụ:', error);
                        showAlert('Không lấy được thông tin tác vụ: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        // Khôi phục trạng thái nút
                        this.disabled = false;
                        this.innerHTML = originalHTML;
                    });
                });
            });
            
            // Xóa sự kiện nút
            document.querySelectorAll('.delete-task').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    document.getElementById('deleteTaskId').value = taskId;
                    
                    // Chức năng xử lý sự kiện phục hồi của nút Xóa xác nhận
                    const confirmBtn = document.getElementById('confirmDeleteBtn');
                    // Loại bỏ một trình nghe sự kiện có thể đã tồn tại trước đó
                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                    
                    // Thêm trình nghe sự kiện cho các nút mới
                    newConfirmBtn.addEventListener('click', function() {
                        deleteTask(taskId, this);
                    });
                    
                    new bootstrap.Modal(document.getElementById('confirmDeleteModal')).show();
                });
            });
            
            // Chạy nút tác vụ
            document.querySelectorAll('.run-task').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    
                    // Hiển thị trạng thái tải
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    this.disabled = true;
                    
                    // gửiAJAXYêu cầu chạy một tác vụ
                    fetch(`/api/tasks/${taskId}/run`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Lỗi phản hồi mạng');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            // Hiển thị kết quả chạy tác vụ
                            if (data.instance_id) {
                                // Nếu thể hiện được trả lạiID，Nhắc xem nhật ký
                                const result = confirm(`tác vụ ${taskId} Bắt đầu chạy，Có xem nhật ký thực thi hay không？`);
                                if (result) {
                                    // Hiển thị tên tác vụ
                                    const taskName = this.closest('tr').querySelector('td:nth-child(2)').textContent;
                                    document.getElementById('logTaskName').textContent = `tác vụ: ${taskName} (Task ID: ${data.instance_id})`;
                                    
                                    // Đặt một phiên bản của nút làm mớiID
                                    document.getElementById('refreshLogBtn').setAttribute('data-instance-id', data.instance_id);
                                    
                                    // Tải nhật ký tác vụ
                                    loadTaskLog(data.instance_id);
                                    
                                    // Hiển thị hộp Modal nhật ký
                                    new bootstrap.Modal(document.getElementById('taskLogModal')).show();
                                }
                            } else {
                                showAlert(`tác vụ ${taskId} Bắt đầu chạy`, 'success');
                            }
                            // Làm mới danh sách tác vụ thay vì toàn bộ trang
                            loadTasks();
                            
                            // Tải lại Lập lịch để cập nhật lịch trình tác vụ
                            setTimeout(() => {
                                fetch('/api/scheduler/reload', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(response => response.json())
                                .then(result => {
                                    console.log('Bộ lập lịch đã được tải lại:', result);
                                    // Làm mới lại sau khi tải lại bộ lập lịch，Đảm bảo thời gian chạy tiếp theo được cập nhật
                                    setTimeout(() => {
                                        loadTasks();
                                    }, 1000);
                                })
                                .catch(err => {
                                    console.error('Bộ lập lịch tải lại không thành công:', err);
                                });
                            }, 500);
                        } else {
                            throw new Error(data.message || 'Chạy không thành công');
                        }
                    })
                    .catch(error => {
                        console.error('Không chạy tác vụ:', error);
                        showAlert('Không chạy tác vụ: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        // Khôi phục trạng thái nút
                        this.innerHTML = originalHTML;
                        this.disabled = false;
                    });
                });
            });
            
            // Xem nút thể hiện tác vụ
            document.querySelectorAll('.view-instances').forEach(button => {
                button.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    const taskName = this.getAttribute('data-task-name');
                    
                    // Hiển thị tên tác vụ
                    document.getElementById('instancesTaskName').textContent = `tác vụ: ${taskName} (ID: ${taskId})`;
                    
                    // Đang tải danh sách thể hiện tác vụ
                    loadTaskInstances(taskId);
                    
                    // Hiển thị hộp phương thức
                    new bootstrap.Modal(document.getElementById('taskInstancesModal')).show();
                });
            });
            
            // Binding Click Events cho các hàng tác vụ
            console.log('hiện hữuattachTaskButtonEventsBINDING BLOP SỰ KIỆN CHO LINE TASK');
            const taskRows = document.querySelectorAll('.task-row');
            taskRows.forEach(row => {
                // Loại bỏ các sự kiện cũ，Ngăn chặn trùng lặp
                row.removeEventListener('click', taskRowClickHandler);
                // Thêm một sự kiện mới
                row.addEventListener('click', taskRowClickHandler);
                console.log('Nhấp vào sự kiện bị ràng buộc với dòng tác vụ:', row.getAttribute('data-task-id'));
            });
        }
        
        // Thêm nhấp vào dòng tác vụ để mở rộng/Chức năng sụp đổ
        function attachTaskRowEvents() {
            console.log('Bắt đầu BINDING Dòng tác vụ Nhấp vào sự kiện...');
            // Nhận tất cả các dòng tác vụ
            const taskRows = document.querySelectorAll('.task-row');
            console.log(`xuất hiện ${taskRows.length} Một tác vụ`);
            
            // Thêm nhấp chuột vào sự kiện cho tất cả các dòng tác vụ
            taskRows.forEach(row => {
                row.addEventListener('click', function(event) {
                    console.log('Dòng tác vụ được nhấp vào:', this.getAttribute('data-task-id'));
                    // Nếu nút được nhấp vào，Chưa được xử lý để mở rộng/Đóng
                    if (event.target.tagName === 'BUTTON' || 
                        event.target.closest('button') || 
                        event.target.tagName === 'I' ||
                        event.target.closest('.btn-group')) {
                        console.log('Nhấp vào khu vực nút，Bỏ qua mở rộng/Đóng');
                        return;
                    }
                    
                    // Nhận một tác vụ ID
                    const taskId = this.getAttribute('data-task-id');
                    console.log('Sẵn sàng chuyển đổi chi tiết hiển thị，tác vụ ID:', taskId);
                    const detailRow = document.getElementById(`task-detail-${taskId}`);
                    if (!detailRow) {
                        console.error(`Không tìm thấy chi tiết task-detail-${taskId}`);
                        return;
                    }
                    
                    // Chuyển đổi trạng thái hiển thị của dòng chi tiết
                    if (detailRow.style.display === 'none' || !detailRow.style.display) {
                        console.log('Hiển thị chi tiết');
                        // Đóng các dòng chi tiết mở khác
                        document.querySelectorAll('.task-detail-row').forEach(row => {
                            if (row.id !== `task-detail-${taskId}`) {
                                row.style.display = 'none';
                                // Xóa trạng thái hoạt động của các hàng khác
                                const otherId = row.id.replace('task-detail-', '');
                                const otherRow = document.querySelector(`.task-row[data-task-id="${otherId}"]`);
                                if (otherRow) otherRow.classList.remove('active-task-row');
                            }
                        });
                        
                        // Hiển thị dòng chi tiết hiện tại
                        detailRow.style.display = 'table-row';
                        this.classList.add('active-task-row');
                    } else {
                        console.log('Ẩn chi tiết');
                        // Ẩn dòng chi tiết hiện tại
                        detailRow.style.display = 'none';
                        this.classList.remove('active-task-row');
                    }
                });
                console.log('Nhấp vào sự kiện bị ràng buộc với dòng tác vụ:', row.getAttribute('data-task-id'));
            });
            
            // Ngăn chặn sự kiện nhấp chuột của dòng chi tiết từ sủi bọt
            document.querySelectorAll('.task-detail-row').forEach(row => {
                row.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
                console.log('Sự kiện nhấp chuột của dòng chi tiết đã bị chặn khỏi sủi bọt:', row.id);
            });
        }
        
        // Trích xuất logic của tác vụ xóa vào một hàm riêng biệt
        function deleteTask(taskId, buttonElement) {
            // Tắt nút，Hiển thị trạng thái tải
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i> Xóa bỏ...';
            
            // gửiAJAXYêu cầu xóa một tác vụ
            fetch(`/api/tasks/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Lỗi phản hồi mạng');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Hiển thị tin nhắn thành công
                    showAlert(`tác vụ ${taskId} Đã xóa`, 'success');
                    // Đóng hộp phương thức
                    bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
                    // Làm mới danh sách tác vụ
                    loadTasks();
                } else {
                    throw new Error(data.message || 'Xóa không thành công');
                }
            })
            .catch(error => {
                console.error('Không xóa tác vụ:', error);
                showAlert('Không xóa tác vụ: ' + error.message, 'danger');
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                buttonElement.disabled = false;
                buttonElement.innerHTML = 'Xác nhận xóa';
            });
        }
        
        // Chức năng trợ giúp：Hiển thị thông báo trong hộp Chế độ tác vụ Thêm
        function showAddTaskMessage(message, type = 'warning') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type} alert-dismissible fade show`;
            messageDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Nhận thùng chứa thông báo để thêm hộp phương thức
            const messageContainer = document.getElementById('addTaskModalMessages') || document.querySelector('#addTaskModal .modal-body');
            
            // Xóa các tin nhắn hiện có
            const existingMessages = messageContainer.querySelectorAll('.alert');
            existingMessages.forEach(msg => msg.remove());
            
            // Thêm thông báo mới vào đầu của container
            messageContainer.insertBefore(messageDiv, messageContainer.firstChild);
            
            // 3Nó tự động biến mất trong vài giây
            setTimeout(() => {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 150);
            }, 3000);
        }
    });
</script>
{% endblock %}