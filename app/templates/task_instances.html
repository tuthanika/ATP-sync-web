{% extends "base.html" %}

{% block title %}Phiên bản tác vụ - Alist-Sync{% endblock %}

{% block page_title %}Bản ghi phiên bản tác vụ{% endblock %}

{% block header_buttons %}
<button class="btn btn-secondary" id="refreshBtn">
    <i class="bi bi-arrow-clockwise"></i> Làm mới dữ liệu
</button>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Phiên bản ID</th>
                                <th>Tên tác vụ</th>
                                <th>tác vụ ID</th>
                                <th>Thời gian bắt đầu</th>
                                <th>Thời gian kết thúc</th>
                                <th>tình trạng</th>
                                <th>vận hành</th>
                            </tr>
                        </thead>
                        <tbody id="instances-table">
                            {% if instances %}
                                {% for instance in instances %}
                                <tr>
                                    <td>{{ instance.task_instances_id }}</td>
                                    <td>{{ instance.task_name }}</td>
                                    <td>{{ instance.task_id }}</td>
                                    <td>{{ instance.start_time_formatted }}</td>
                                    <td>{{ instance.end_time_formatted or "Trong tiến trình" }}</td>
                                    <td>
                                        {% if instance.status == 'running' %}
                                        <span class="badge bg-primary">Đang chạy</span>
                                        {% elif instance.status == 'completed' %}
                                        <span class="badge bg-success">Hoàn thành</span>
                                        {% elif instance.status == 'failed' %}
                                        <span class="badge bg-danger">thất bại</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ instance.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-info view-log" data-instance-id="{{ instance.task_instances_id }}" data-task-name="{{ instance.task_name }}">
                                                <i class="bi bi-file-text"></i>
                                            </button>
                                            {% if instance.status == 'failed' %}
                                            <button class="btn btn-sm btn-warning view-error" data-instance-id="{{ instance.task_instances_id }}" data-error="{{ instance.result.message }}">
                                                <i class="bi bi-exclamation-triangle"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">Chưa có ví dụ nào</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hộp Modal Chế độ xem nhật ký tác vụ -->
<div class="modal fade" id="taskLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nhật ký thực thi tác vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="logTaskName" class="mb-3"></h6>
                <div class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto;">
                    <pre id="task-log-content" class="mb-0" style="white-space: pre-wrap;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="refreshLogBtn">làm cho khỏe lại</button>
            </div>
        </div>
    </div>
</div>

<!-- Hộp phương thức chi tiết lỗi -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết lỗi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" id="error-message"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Nút làm mới
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });
        
        // Xem sự kiện nút nhật ký
        document.querySelectorAll('.view-log').forEach(button => {
            button.addEventListener('click', function() {
                const instanceId = this.getAttribute('data-instance-id');
                const taskName = this.getAttribute('data-task-name');
                
                // Hiển thị tên tác vụ
                document.getElementById('logTaskName').textContent = `tác vụ: ${taskName} (Task ID: ${instanceId})`;
                
                // Đặt một phiên bản của nút làm mớiID
                document.getElementById('refreshLogBtn').setAttribute('data-instance-id', instanceId);
                
                // Tải nhật ký tác vụ
                loadTaskLog(instanceId);
                
                // Hiển thị hộp Modal nhật ký
                new bootstrap.Modal(document.getElementById('taskLogModal')).show();
            });
        });
        
        // Làm mới nút nhật ký
        document.getElementById('refreshLogBtn').addEventListener('click', function() {
            const instanceId = this.getAttribute('data-instance-id');
            if (instanceId) {
                loadTaskLog(instanceId);
            }
        });
        
        // Xem sự kiện nút chi tiết lỗi
        document.querySelectorAll('.view-error').forEach(button => {
            button.addEventListener('click', function() {
                const errorMessage = this.getAttribute('data-error');
                
                // Hiển thị thông báo lỗi
                document.getElementById('error-message').textContent = errorMessage;
                
                // Hiển thị hộp phương thức lỗi
                new bootstrap.Modal(document.getElementById('errorModal')).show();
            });
        });
        
        // Chức năng trợ giúp：Tải nhật ký tác vụ
        function loadTaskLog(instanceId) {
            const logContent = document.getElementById('task-log-content');
            logContent.textContent = 'đang tải...';
            
            fetch(`/api/task-instances/${instanceId}/logs`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.logs && data.logs.length > 0) {
                    logContent.textContent = data.logs.join('\n');
                } else {
                    logContent.textContent = 'Không tìm thấy ghi nhật ký';
                }
            })
            .catch(error => {
                console.error('Không tải được nhật ký tác vụ:', error);
                logContent.textContent = 'Không tải được nhật ký: ' + error.message;
            });
        }
    });
</script>
{% endblock %} 