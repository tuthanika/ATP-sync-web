{% extends "base.html" %}

{% block title %}Cài đặt hệ thống - Alist-Sync{% endblock %}

{% block page_title %}Cài đặt hệ thống{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card bg-dark-subtle">
            <div class="card-body">
                <form id="settingsForm">
                    <div class="row mb-4">
                        <h5 class="border-bottom pb-2">Cấu hình hiệu suất</h5>
                        
                        <div class="col-md-6 mb-3">
                            <label for="maxConcurrentTasks" class="form-label">Số lượng tác vụ đồng thời tối đa</label>
                            <input type="number" class="form-control bg-dark text-light" id="maxConcurrentTasks" 
                                value="{{ settings.max_concurrent_tasks }}" min="1" max="10">
                            <div class="form-text">Số lượng tác vụ tối đa được thực hiện đồng thời，Nên đặt hiệu suất hệ thống</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="defaultRetryCount" class="form-label">Số lượng thử lại mặc định</label>
                            <input type="number" class="form-control bg-dark text-light" id="defaultRetryCount" 
                                value="{{ settings.default_retry_count }}" min="0" max="10">
                            <div class="form-text">Số lần thử lại sau khi kết nối thất bại</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="defaultBlockSize" class="form-label">Kích thước khối tệp (Byte)</label>
                            <input type="number" class="form-control bg-dark text-light" id="defaultBlockSize" 
                                value="{{ settings.default_block_size }}" min="1048576" step="1048576">
                            <div class="form-text">Kích thước khối trong quá trình truyền tệp lớn，mặc định 10MB (10485760 Byte)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="bandwidthLimit" class="form-label">Giới hạn băng thông (KB/s)</label>
                            <input type="number" class="form-control bg-dark text-light" id="bandwidthLimit" 
                                value="{{ settings.bandwidth_limit }}" min="0" step="1024">
                            <div class="form-text">0 Cho biết không có giới hạn，Nên đặt các hạn chế khi có nhiều tác vụ</div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <h5 class="border-bottom pb-2">Cài đặt nhật ký</h5>
                        
                        <div class="col-md-6 mb-3">
                            <label for="logLevel" class="form-label">Mức độ nhật ký</label>
                            <select class="form-select bg-dark text-light" id="logLevel">
                                <option value="DEBUG" {% if settings.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="INFO" {% if settings.log_level == 'INFO' %}selected{% endif %}>INFO</option>
                                <option value="WARN" {% if settings.log_level == 'WARN' %}selected{% endif %}>WARN</option>
                                <option value="ERROR" {% if settings.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                            </select>
                            <div class="form-text">Kiểm soát chi tiết nhật ký của bản ghi</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="keepLogDays" class="form-label">Ngày lưu giữ nhật ký tác vụ</label>
                            <input type="number" class="form-control bg-dark text-light" id="keepLogDays" 
                                value="{{ settings.keep_log_days }}" min="1" max="30">
                            <div class="form-text">Nhật ký vượt quá số ngày này sẽ được làm sạch tự động</div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <h5 class="border-bottom pb-2">Tùy chọn nâng cao</h5>
                        
                        <div class="col-md-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="debugMode" 
                                    {% if settings.debug_mode %}checked{% endif %}>
                                <label class="form-check-label" for="debugMode">Chế độ gỡ lỗi</label>
                            </div>
                            <div class="form-text">Bật chế độ gỡ lỗi sẽ ghi lại thông tin chi tiết hơn</div>
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableWebhook" 
                                    {% if settings.enable_webhook %}checked{% endif %}>
                                <label class="form-check-label" for="enableWebhook">Cho phép thông báo</label>
                            </div>
                            <div class="form-text">Gửi thông báo sau khi hoàn thành tác vụ</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="notificationType" class="form-label">Phương thức thông báo</label>
                            <select class="form-select bg-dark text-light" id="notificationType">
                                <option value="webhook" {% if settings.notification_type == 'webhook' %}selected{% endif %}>Tùy chỉnh Webhook</option>
                                <option value="feishu" {% if settings.notification_type == 'feishu' %}selected{% endif %}>Robot Feishu</option>
                                <option value="dingtalk" {% if settings.notification_type == 'dingtalk' %}selected{% endif %}>Robot Dingtalk</option>
                                <option value="wecom" {% if settings.notification_type == 'wecom' %}selected{% endif %}>Enterprise WeChat Robot</option>
                                <option value="bark" {% if settings.notification_type == 'bark' %}selected{% endif %}>Bark</option>
                                <option value="pushplus" {% if settings.notification_type == 'pushplus' %}selected{% endif %}>PushPlus</option>
                                <option value="telegram" {% if settings.notification_type == 'telegram' %}selected{% endif %}>Telegram</option>
                            </select>
                            <div class="form-text">Chọn phương thức gửi thông báo</div>
                        </div>
                        
                        <div class="col-md-12 mb-3 webhook-settings">
                            <label for="webhookUrl" class="form-label">Webhook URL</label>
                            <input type="url" class="form-control bg-dark text-light" id="webhookUrl" 
                                value="{{ settings.webhook_url }}" placeholder="https://your-webhook-url.com">
                            <div class="form-text">WebhookĐịa chỉ giao diện</div>
                        </div>
                        
                        <!-- Cài đặt dingtalent -->
                        <div class="col-md-12 mb-3 dingtalk-settings" style="display: none;">
                            <label for="dingtalkSecret" class="form-label">Phím ký DingTalk</label>
                            <input type="text" class="form-control bg-dark text-light" id="dingtalkSecret" 
                                value="{{ settings.dingtalk_secret }}" placeholder="SEC000000000000000000000">
                            <div class="form-text">KEY đăng ký trong các cài đặt bảo mật robot dingding，Nếu đăng ký không được bật, hãy để trống</div>
                        </div>
                        
                        <!-- BarkCài đặt đặc biệt -->
                        <div class="col-md-12 mb-3 bark-settings" style="display: none;">
                            <label for="barkSound" class="form-label">BarkÂm thanh nhanh chóng</label>
                            <input type="text" class="form-control bg-dark text-light" id="barkSound" 
                                value="{{ settings.bark_sound|default('default') }}" placeholder="default">
                            <div class="form-text">BarkThông báo âm thanh nhắc nhở，Mặc định làdefault</div>
                        </div>
                        
                        <!-- TelegramCài đặt đặc biệt -->
                        <div class="telegram-settings" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <label for="telegramBotToken" class="form-label">Telegram Bot Token</label>
                                <input type="text" class="form-control bg-dark text-light" id="telegramBotToken" 
                                    value="{{ settings.telegram_bot_token }}" placeholder="123456789:ABCdefGhIJKlmNoPQRsTUVwxyZ">
                                <div class="form-text">vượt qua BotFather Robot được tạo raToken</div>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="telegramChatId" class="form-label">Telegram Chat ID</label>
                                <input type="text" class="form-control bg-dark text-light" id="telegramChatId" 
                                    value="{{ settings.telegram_chat_id }}" placeholder="-123456789">
                                <div class="form-text">Các cuộc trò chuyện nhận được tin nhắnID，Có sẵn @userinfobot Lấy</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="refreshInterval" class="form-label">Làm mới khoảng thời gian (Thứ hai)</label>
                        <input type="number" class="form-control bg-dark text-light" id="refreshInterval" value="{{ settings.refresh_interval|default(60) }}">
                        <div class="form-text text-muted">Khoảng thời gian làm mới bảng điều khiển tự động，Đặt như0Tắt tự động làm mới</div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-danger" id="resetSettingsBtn">Khôi phục cài đặt mặc định</button>
                        <button type="button" class="btn btn-primary" id="saveSettingsBtn">Lưu cài đặt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Xác nhận đặt lại hộp phương thức đặt lại -->
<div class="modal fade" id="confirmResetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận đặt lại</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc là bạn muốn khôi phục tất cả các cài đặt về giá trị mặc định?？Hoạt động này không được khôi phục。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-danger" id="confirmResetBtn">Xác nhận đặt lại</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Hiển thị các tùy chọn cấu hình tương ứng theo loại thông báo
        function updateNotificationSettings() {
            const notificationType = document.getElementById('notificationType').value;
            
            // Ẩn tất cả các cài đặt cụ thể
            document.querySelectorAll('.webhook-settings, .dingtalk-settings, .bark-settings, .telegram-settings').forEach(el => {
                el.style.display = 'none';
            });
            
            // Hiển thị các cài đặt chung
            document.querySelector('.webhook-settings').style.display = 'block';
            
            // Hiển thị các cài đặt cụ thể
            if (notificationType === 'dingtalk') {
                document.querySelector('.dingtalk-settings').style.display = 'block';
            } else if (notificationType === 'bark') {
                document.querySelector('.bark-settings').style.display = 'block';
            } else if (notificationType === 'telegram') {
                document.querySelector('.telegram-settings').style.display = 'block';
            }
        }
        
        // Khởi tạo màn hình
        updateNotificationSettings();
        
        // Thay đổi lựa chọn nghe
        document.getElementById('notificationType').addEventListener('change', updateNotificationSettings);
        
        // Lưu cài đặt
        document.getElementById('saveSettingsBtn').addEventListener('click', function() {
            // Thu thập dữ liệu biểu mẫu
            const settings = {
                max_concurrent_tasks: parseInt(document.getElementById('maxConcurrentTasks').value),
                default_retry_count: parseInt(document.getElementById('defaultRetryCount').value),
                default_block_size: parseInt(document.getElementById('defaultBlockSize').value),
                bandwidth_limit: parseInt(document.getElementById('bandwidthLimit').value),
                log_level: document.getElementById('logLevel').value,
                keep_log_days: parseInt(document.getElementById('keepLogDays').value),
                debug_mode: document.getElementById('debugMode').checked,
                enable_webhook: document.getElementById('enableWebhook').checked,
                notification_type: document.getElementById('notificationType').value,
                webhook_url: document.getElementById('webhookUrl').value,
                dingtalk_secret: document.getElementById('dingtalkSecret').value,
                bark_sound: document.getElementById('barkSound').value,
                telegram_bot_token: document.getElementById('telegramBotToken').value,
                telegram_chat_id: document.getElementById('telegramChatId').value,
                refresh_interval: parseInt(document.getElementById('refreshInterval').value)
            };
            
            // Thực hiện xác minh đơn giản
            if (settings.max_concurrent_tasks < 1 || settings.max_concurrent_tasks > 10) {
                alert('Số lượng tác vụ đồng thời tối đa nên 1-10 giữa');
                return;
            }
            
            if (settings.enable_webhook && !settings.webhook_url) {
                alert('Cho phép Webhook Phải được cung cấp khi URL');
                return;
            }
            
            // Gửi đến máy chủ
            fetch('/api/settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Cài đặt được lưu');
                } else {
                    alert('Lưu cài đặt không thành công: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Lưu lỗi cài đặt:', error);
                alert('Lưu cài đặt không thành công，Vui lòng kiểm tra kết nối mạng');
            });
        });
        
        // Đặt lại cài đặt
        document.getElementById('resetSettingsBtn').addEventListener('click', function() {
            // Hiển thị hộp thoại xác nhận
            new bootstrap.Modal(document.getElementById('confirmResetModal')).show();
        });
        
        // Xác nhận đặt lại
        document.getElementById('confirmResetBtn').addEventListener('click', function() {
            // Mô phỏng hoạt động đặt lại
            document.getElementById('maxConcurrentTasks').value = '3';
            document.getElementById('defaultRetryCount').value = '3';
            document.getElementById('defaultBlockSize').value = '10485760';
            document.getElementById('bandwidthLimit').value = '0';
            document.getElementById('logLevel').value = 'INFO';
            document.getElementById('keepLogDays').value = '7';
            document.getElementById('debugMode').checked = false;
            document.getElementById('enableWebhook').checked = false;
            document.getElementById('notificationType').value = 'webhook';
            document.getElementById('webhookUrl').value = '';
            document.getElementById('dingtalkSecret').value = '';
            document.getElementById('barkSound').value = 'default';
            document.getElementById('telegramBotToken').value = '';
            document.getElementById('telegramChatId').value = '-123456789';
            document.getElementById('refreshInterval').value = '60';
            
            // Ẩn hộp phương thức
            bootstrap.Modal.getInstance(document.getElementById('confirmResetModal')).hide();
            
            // Thành công nhanh chóng
            alert('Cài đặt đã được đặt lại về giá trị mặc định');
        });
    });
</script>
{% endblock %} 