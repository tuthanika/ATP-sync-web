{% extends "base.html" %}

{% block title %}Bảng chính - Alist-Sync{% endblock %}

{% block page_title %}Bảng điều khiển hệ thống{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Thẻ thống kê -->
    <div class="col-md-3">
        <div class="card bg-primary bg-gradient text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Số lượng kết nối</h5>
                        <h2 class="display-5 fw-bold" id="connection-count">0</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-hdd-network fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success bg-gradient text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Số lượng tác vụ</h5>
                        <h2 class="display-5 fw-bold" id="task-count">0</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-list-task fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info bg-gradient text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">tác vụ tích cực</h5>
                        <h2 class="display-5 fw-bold" id="active-task-count">0</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-play-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning bg-gradient text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Tổng số tập tin đồng bộ hóa</h5>
                        <h2 class="display-5 fw-bold" id="synced-files-count">0</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="bi bi-files fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ phân phối trạng thái tác vụ -->
    <div class="col-md-6">
        <div class="card bg-dark-subtle">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">tác vụ phân phối trạng thái</h5>
            </div>
            <div class="card-body">
                <canvas id="task-status-chart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ thống kê loại kết nối -->
    <div class="col-md-6">
        <div class="card bg-dark-subtle">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Phân phối loại kết nối</h5>
            </div>
            <div class="card-body">
                <canvas id="connection-type-chart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ thống kê thời gian thực hiện tác vụ -->
    <div class="col-md-6">
        <div class="card bg-dark-subtle">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Thống kê thời gian thực hiện tác vụ</h5>
            </div>
            <div class="card-body">
                <canvas id="task-duration-chart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Biểu đồ tỷ lệ thành công thực thi tác vụ -->
    <div class="col-md-6">
        <div class="card bg-dark-subtle">
            <div class="card-header bg-transparent">
                <h5 class="card-title mb-0">Tỷ lệ thực hiện tác vụ</h5>
            </div>
            <div class="card-body">
                <canvas id="task-success-rate-chart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Mẫu tác vụ gần đây -->
    <div class="col-md-12">
        <div class="card bg-dark-subtle">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">tác vụ gần đây thực hiện</h5>
                <a href="{{ url_for('main.tasks') }}" class="btn btn-sm btn-primary">Xem tất cả</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Tên tác vụ</th>
                                <th>Loại đồng bộ hóa</th>
                                <th>Đường dẫn nguồn</th>
                                <th>Đường dẫn mục tiêu</th>
                                <th>tình trạng</th>
                                <th>Thực hiện cuối cùng</th>
                                <th>vận hành</th>
                            </tr>
                        </thead>
                        <tbody id="recent-tasks">
                            <tr>
                                <td colspan="7" class="text-center">Chưa có dữ liệu tác vụ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tải dữ liệu
        loadDashboardData();
        
        // Đặt khoảng thời gian làm mới（Lấy nó từ phía máy chủ）
        var refreshInterval = {% if settings and settings.refresh_interval %}{{ settings.refresh_interval }}{% else %}60{% endif %};
        if (refreshInterval > 0) {
            setInterval(loadDashboardData, refreshInterval * 1000);
        }
    });
    
    // Tải dữ liệu bảng điều khiển
    function loadDashboardData() {
        fetch('/api/dashboard/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error('Lỗi phản hồi mạng');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                updateDashboardStats(data.data);
                updateCharts(data.data);
                updateRecentTasks(data.data.recent_tasks);
            }
        })
        .catch(error => {
            console.error('Không lấy được dữ liệu bảng điều khiển:', error);
        });
    }
    
    // Cập nhật số liệu thống kê
    function updateDashboardStats(stats) {
        document.getElementById('connection-count').textContent = stats.connection_count || 0;
        document.getElementById('task-count').textContent = stats.task_count || 0;
        document.getElementById('active-task-count').textContent = stats.active_task_count || 0;
        document.getElementById('synced-files-count').textContent = stats.synced_files_count || 0;
    }
    
    // Cập nhật biểu đồ
    function updateCharts(stats) {
        // Biểu đồ trạng thái tác vụ
        var taskStatusChartData = {
            labels: ['Hoàn thành', 'Đang tiến hành', 'thất bại', 'Chờ'],
            datasets: [{
                data: [
                    stats.completed_task_count || 0, 
                    stats.running_task_count || 0, 
                    stats.failed_task_count || 0, 
                    stats.pending_task_count || 0
                ],
                backgroundColor: [
                    '#198754', // màu xanh lá
                    '#0d6efd', // màu xanh da trời
                    '#dc3545', // màu đỏ
                    '#6c757d'  // xám
                ],
                borderWidth: 0
            }]
        };
        
        if (window.taskStatusChart) {
            window.taskStatusChart.data = taskStatusChartData;
            window.taskStatusChart.update();
        } else {
            var taskStatusCtx = document.getElementById('task-status-chart').getContext('2d');
            window.taskStatusChart = new Chart(taskStatusCtx, {
                type: 'doughnut',
                data: taskStatusChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#212529'
                            }
                        }
                    }
                }
            });
        }
        
        // Biểu đồ phân phối loại kết nối
        var connectionTypeChartData = {
            labels: stats.connection_types || ['Alibaba Cloud Drive', 'Baidu Netdisk', 'Quark Netdisk', 'Đĩa đám mây Tianyi', 'OneDrive'],
            datasets: [{
                data: stats.connection_type_counts || [2, 1, 2, 1, 1],
                backgroundColor: [
                    '#0d6efd', // màu xanh da trời
                    '#dc3545', // màu đỏ
                    '#ffc107', // màu vàng
                    '#198754', // màu xanh lá
                    '#6f42c1'  // Màu tím
                ],
                borderWidth: 0
            }]
        };
        
        if (window.connectionTypeChart) {
            window.connectionTypeChart.data = connectionTypeChartData;
            window.connectionTypeChart.update();
        } else {
            var connectionTypeCtx = document.getElementById('connection-type-chart').getContext('2d');
            window.connectionTypeChart = new Chart(connectionTypeCtx, {
                type: 'pie',
                data: connectionTypeChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#212529'
                            }
                        }
                    }
                }
            });
        }
        
        // Biểu đồ thống kê thời gian thực hiện tác vụ
        var taskDurationData = {
            labels: stats.task_duration_labels || ['Ít hơn 1phút', '1-5phút', '5-15phút', '15-30phút', '30phút以上'],
            datasets: [{
                label: 'Số lượng tác vụ',
                data: stats.task_duration_counts || [8, 5, 3, 2, 1],
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderColor: '#0d6efd',
                borderWidth: 1
            }]
        };
        
        if (window.taskDurationChart) {
            window.taskDurationChart.data = taskDurationData;
            window.taskDurationChart.update();
        } else {
            var taskDurationCtx = document.getElementById('task-duration-chart').getContext('2d');
            window.taskDurationChart = new Chart(taskDurationCtx, {
                type: 'bar',
                data: taskDurationData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#212529'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#212529'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Biểu đồ tỷ lệ thành công thực thi tác vụ
        var successRateData = {
            labels: stats.success_rate_labels || ['Bài kiểm tra1', 'Bài kiểm tra2', 'Bài kiểm tra3', 'Bài kiểm tra4', 'Bài kiểm tra5'],
            datasets: [{
                label: 'Tỷ lệ thành công (%)',
                data: stats.success_rate_values || [80, 95, 60, 100, 85],
                backgroundColor: [
                    'rgba(25, 135, 84, 0.7)',
                    'rgba(25, 135, 84, 0.7)',
                    'rgba(220, 53, 69, 0.7)',
                    'rgba(25, 135, 84, 0.7)',
                    'rgba(25, 135, 84, 0.7)'
                ],
                borderColor: [
                    '#198754',
                    '#198754',
                    '#dc3545',
                    '#198754',
                    '#198754'
                ],
                borderWidth: 1
            }]
        };
        
        if (window.successRateChart) {
            window.successRateChart.data = successRateData;
            window.successRateChart.update();
        } else {
            var successRateCtx = document.getElementById('task-success-rate-chart').getContext('2d');
            window.successRateChart = new Chart(successRateCtx, {
                type: 'bar',
                data: successRateData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#212529'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#212529'
                            }
                        }
                    }
                }
            });
        }
    }
    
    // Cập nhật các bảng tác vụ gần đây
    function updateRecentTasks(tasks) {
        var tableBody = document.getElementById('recent-tasks');
        if (!tasks || tasks.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Chưa có dữ liệu tác vụ</td></tr>';
            return;
        }
        
        var html = '';
        tasks.forEach(function(task) {
            var statusClass = '';
            var statusText = '';
            
            switch(task.status) {
                case 'completed':
                    statusClass = 'success';
                    statusText = 'Hoàn thành';
                    break;
                case 'running':
                    statusClass = 'primary';
                    statusText = 'Đang chạy';
                    break;
                case 'failed':
                    statusClass = 'danger';
                    statusText = 'thất bại';
                    break;
                default:
                    statusClass = 'secondary';
                    statusText = 'Chờ';
            }
            
            html += `<tr>
                <td>${task.name}</td>
                <td>${task.sync_type === 'file_sync' ? 'Đồng bộ hóa tệp' : 'khác'}</td>
                <td title="${task.source_path}">${task.source_path}</td>
                <td title="${task.target_path}">${task.target_path}</td>
                <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                <td>${task.last_run || '-'}</td>
                <td>
                    <a href="/tasks?edit=${task.id}" class="btn btn-sm btn-outline-info me-1" title="biên tập">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-success me-1" onclick="runTask(${task.id})" title="Chạy ngay">
                        <i class="bi bi-play"></i>
                    </button>
                </td>
            </tr>`;
        });
        
        tableBody.innerHTML = html;
    }
    
    // Chạy tác vụ ngay bây giờ
    function runTask(taskId) {
        if (confirm('Bạn có chắc là bạn muốn chạy tác vụ này ngay lập tức？')) {
            fetch(`/api/tasks/${taskId}/run`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('tác vụ đã được bắt đầu');
                    setTimeout(loadDashboardData, 1000);
                } else {
                    alert('Không thể bắt đầu tác vụ: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Chạy lỗi tác vụ:', error);
                alert('Không chạy tác vụ: ' + error.message);
            });
        }
    }
</script>
{% endblock %} 