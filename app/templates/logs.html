{% extends "base.html" %}

{% block title %}Xem nhật ký - Alist-Sync{% endblock %}

{% block page_title %}Nhật ký hệ thống{% endblock %}

{% block header_buttons %}
<div class="btn-group">
    <button class="btn btn-secondary" id="refreshLogsBtn">
        <i class="bi bi-arrow-clockwise"></i> làm cho khỏe lại
    </button>
    <button class="btn btn-warning" id="repairLogsBtn">
        <i class="bi bi-tools"></i> Nhật ký sửa chữa
    </button>
    <button class="btn btn-danger" id="clearLogsBtn">
        <i class="bi bi-trash"></i> Xóa nhật ký
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-dark-subtle">
            <div class="card-body p-3">
                <form id="logFilterForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="logLevel" class="form-label">Mức độ nhật ký</label>
                        <select class="form-select bg-dark text-light" id="logLevel">
                            <option value="">Tất cả các cấp độ</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARN">WARN</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="taskFilter" class="form-label">Lọc tác vụ</label>
                        <select class="form-select bg-dark text-light" id="taskFilter">
                            <option value="">Tất cả các nhiệm vụ</option>
                            {% for task in tasks %}
                            <option value="{{ task.id }}">{{ task.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchText" class="form-label">Tìm kiếm từ khóa</label>
                        <input type="text" class="form-control bg-dark text-light" id="searchText" placeholder="Nhập từ khóa">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" id="applyFilterBtn">Bộ lọc ứng dụng</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card bg-dark-subtle">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th style="width: 200px;">thời gian</th>
                                <th style="width: 80px;">mức độ</th>
                                <th style="width: 120px;">Nhiệm vụ</th>
                                <th>thông tin</th>
                                <th style="width: 100px;">vận hành</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table">
                            {% if logs %}
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log.timestamp_formatted }}</td>
                                    <td>
                                        {% if log.level == 'ERROR' %}
                                        <span class="badge bg-danger">ERROR</span>
                                        {% elif log.level == 'WARN' %}
                                        <span class="badge bg-warning text-dark">WARN</span>
                                        {% elif log.level == 'INFO' %}
                                        <span class="badge bg-info text-dark">INFO</span>
                                        {% elif log.level == 'DEBUG' %}
                                        <span class="badge bg-secondary">DEBUG</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if log.task_name %}
                                            {{ log.task_name }}
                                        {% elif log.task_id %}
                                            Nhiệm vụ {{ log.task_id }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ log.message }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info view-details" 
                                               data-log-id="{{ log.id }}" 
                                               data-timestamp="{{ log.timestamp }}"
                                               data-bs-toggle="modal" 
                                               data-bs-target="#logDetailsModal">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">Chưa đăng nhập</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Kiểm soát phân trang -->
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Trang trước</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Trang tiếp theo</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Hộp phương thức chi tiết đăng nhập -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết đăng nhập</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>thời gian：</strong> <span id="detailTimestamp"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>mức độ：</strong> <span id="detailLevel"></span></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Nhiệm vụ：</strong> <span id="detailTask"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Nhiệm vụ ID：</strong> <span id="detailTaskId"></span></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <p><strong>thông tin：</strong></p>
                        <div class="p-3 bg-secondary bg-opacity-25 rounded" id="detailMessage"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p><strong>Chi tiết：</strong></p>
                        <pre class="p-3 bg-secondary bg-opacity-25 rounded overflow-auto" style="max-height: 200px;" id="detailData"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng cửa</button>
            </div>
        </div>
    </div>
</div>

<!-- Xác nhận để xóa hộp Modal Log -->
<div class="modal fade" id="confirmClearModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận để xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc là bạn muốn xóa tất cả các bản ghi nhật ký?？Hoạt động này không được khôi phục。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-danger" id="confirmClearBtn">Xác nhận để xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Xác nhận để sửa chữa hộp phương thức nhật ký -->
<div class="modal fade" id="confirmRepairModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Sửa chữa hệ thống nhật ký</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Điều này sẽ cố gắng sửa chữa hệ thống nhật ký，Đảm bảo rằng nhật ký có thể được ghi lại bình thường。Có tiếp tục？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy bỏ</button>
                <button type="button" class="btn btn-warning" id="confirmRepairBtn">Xác nhận sửa chữa</button>
            </div>
        </div>
    </div>
</div>

<!-- Sửa hộp kết quả hộp phương thức -->
<div class="modal fade" id="repairResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">Khắc phục kết quả</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="repairResultContent">
                <!-- Kết quả sẽ làJSĐã Thêm  -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng cửa</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Xem chi tiết nhật ký
        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function() {
                const logId = this.getAttribute('data-log-id');
                const timestamp = this.getAttribute('data-timestamp');
                
                // Nhận chi tiết nhật ký từ máy chủ
                fetch(`/api/logs?timestamp=${timestamp}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' && data.logs && data.logs.length > 0) {
                            const logDetails = data.logs[0];
                            
                            // Điền vào dữ liệu hộp phương thức，Sử dụng dấu thời gian định dạng
                            document.getElementById('detailTimestamp').textContent = logDetails.timestamp_formatted;
                            document.getElementById('detailLevel').textContent = logDetails.level;
                            
                            // Tên nhiệm vụ xử lý vàID
                            if (logDetails.task_name) {
                                document.getElementById('detailTask').textContent = logDetails.task_name;
                            } else if (logDetails.task_id) {
                                document.getElementById('detailTask').textContent = `Nhiệm vụ ${logDetails.task_id}`;
                            } else {
                                document.getElementById('detailTask').textContent = 'Nhiệm vụ không liên kết';
                            }
                            
                            document.getElementById('detailTaskId').textContent = logDetails.task_id || '-';
                            document.getElementById('detailMessage').textContent = logDetails.message;
                            document.getElementById('detailData').textContent = JSON.stringify(logDetails.details || {}, null, 2);
                        } else {
                            alert('Không nhận được chi tiết nhật ký: ' + (data.message || 'Không tìm thấy nhật ký'));
                        }
                    })
                    .catch(error => {
                        console.error('Lỗi khi nhận chi tiết nhật ký:', error);
                        alert('Không nhận được chi tiết nhật ký');
                    });
            });
        });
        
        // Bộ lọc ứng dụng
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            const level = document.getElementById('logLevel').value;
            const taskId = document.getElementById('taskFilter').value;
            const searchText = document.getElementById('searchText').value;
            
            // Xây dựng chuỗi truy vấn
            const queryParams = new URLSearchParams();
            if (level) queryParams.append('level', level);
            if (taskId) queryParams.append('task_id', taskId);
            if (searchText) queryParams.append('search', searchText);
            
            // Hiển thị trạng thái tải
            const logsTable = document.getElementById('logs-table');
            logsTable.innerHTML = '<tr><td colspan="5" class="text-center"><div class="loading-spinner mx-auto my-3"></div></td></tr>';
            
            // Gửi yêu cầu bộ lọc
            fetch(`/api/logs?${queryParams.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Xóa hình thức
                        logsTable.innerHTML = '';
                        
                        if (data.logs && data.logs.length > 0) {
                            // Điền vào dữ liệu nhật ký được lọc
                            data.logs.forEach(log => {
                                const row = document.createElement('tr');
                                
                                // Sử dụng dấu thời gian định dạng
                                const timestampCell = document.createElement('td');
                                timestampCell.textContent = log.timestamp_formatted;
                                row.appendChild(timestampCell);
                                
                                // Mức độ nhật ký
                                const levelCell = document.createElement('td');
                                const levelBadge = document.createElement('span');
                                levelBadge.classList.add('badge');
                                
                                if (log.level === 'ERROR') {
                                    levelBadge.classList.add('bg-danger');
                                    levelBadge.textContent = 'ERROR';
                                } else if (log.level === 'WARN') {
                                    levelBadge.classList.add('bg-warning', 'text-dark');
                                    levelBadge.textContent = 'WARN';
                                } else if (log.level === 'INFO') {
                                    levelBadge.classList.add('bg-info', 'text-dark');
                                    levelBadge.textContent = 'INFO';
                                } else if (log.level === 'DEBUG') {
                                    levelBadge.classList.add('bg-secondary');
                                    levelBadge.textContent = 'DEBUG';
                                }
                                
                                levelCell.appendChild(levelBadge);
                                row.appendChild(levelCell);
                                
                                // Tên nhiệm vụ
                                const taskCell = document.createElement('td');
                                if (log.task_name) {
                                    taskCell.textContent = log.task_name;
                                } else if (log.task_id) {
                                    taskCell.textContent = `Nhiệm vụ ${log.task_id}`;
                                } else {
                                    taskCell.textContent = '-';
                                }
                                row.appendChild(taskCell);
                                
                                // thông tin
                                const messageCell = document.createElement('td');
                                messageCell.textContent = log.message;
                                row.appendChild(messageCell);
                                
                                // Thêm "Kiểm tra"Cái nút
                                const actionCell = document.createElement('td');
                                
                                const viewButton = document.createElement('button');
                                viewButton.classList.add('btn', 'btn-sm', 'btn-info', 'view-details');
                                viewButton.setAttribute('data-log-id', log.id);
                                viewButton.setAttribute('data-timestamp', log.timestamp);
                                viewButton.setAttribute('data-bs-toggle', 'modal');
                                viewButton.setAttribute('data-bs-target', '#logDetailsModal');
                                
                                // Thêm một biểu tượng
                                const icon = document.createElement('i');
                                icon.classList.add('bi', 'bi-eye');
                                viewButton.appendChild(icon);
                                
                                // Thêm trình nghe sự kiện vào các nút
                                viewButton.addEventListener('click', function() {
                                    const logId = this.getAttribute('data-log-id');
                                    const timestamp = this.getAttribute('data-timestamp');
                                    
                                    // Nhận chi tiết nhật ký từ máy chủ
                                    fetch(`/api/logs?timestamp=${timestamp}`)
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.status === 'success' && data.logs && data.logs.length > 0) {
                                                const logDetails = data.logs[0];
                                                
                                                // Điền vào dữ liệu hộp phương thức
                                                document.getElementById('detailTimestamp').textContent = logDetails.timestamp_formatted;
                                                document.getElementById('detailLevel').textContent = logDetails.level;
                                                
                                                // Tên nhiệm vụ xử lý vàID
                                                if (logDetails.task_name) {
                                                    document.getElementById('detailTask').textContent = logDetails.task_name;
                                                } else if (logDetails.task_id) {
                                                    document.getElementById('detailTask').textContent = `Nhiệm vụ ${logDetails.task_id}`;
                                                } else {
                                                    document.getElementById('detailTask').textContent = 'Nhiệm vụ không liên kết';
                                                }
                                                
                                                document.getElementById('detailTaskId').textContent = logDetails.task_id || '-';
                                                document.getElementById('detailMessage').textContent = logDetails.message;
                                                document.getElementById('detailData').textContent = JSON.stringify(logDetails.details || {}, null, 2);
                                            } else {
                                                alert('Không nhận được chi tiết nhật ký: ' + (data.message || 'Không tìm thấy nhật ký'));
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Lỗi khi nhận chi tiết nhật ký:', error);
                                            alert('Không nhận được chi tiết nhật ký');
                                        });
                                });
                                
                                actionCell.appendChild(viewButton);
                                row.appendChild(actionCell);
                                
                                logsTable.appendChild(row);
                            });
                        } else {
                            // Không có nhật ký đáp ứng các tiêu chí
                logsTable.innerHTML = '<tr><td colspan="5" class="text-center">Không đăng nhập nào đáp ứng các tiêu chí</td></tr>';
                        }
                    } else {
                        alert('Không thể lọc nhật ký: ' + data.message);
                        logsTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Bộ lọc không thành công</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Lỗi nhật ký lọc:', error);
                    logsTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi mạng，Hãy thử lại</td></tr>';
                });
        });
        
        // Làm mới nhật ký
        document.getElementById('refreshLogsBtn').addEventListener('click', function() {
            window.location.reload();
        });
        
        // Nhật ký sửa chữa
        document.getElementById('repairLogsBtn').addEventListener('click', function() {
            // Hiển thị hộp thoại xác nhận
            new bootstrap.Modal(document.getElementById('confirmRepairModal')).show();
        });
        
        // Xác nhận sửa chữa
        document.getElementById('confirmRepairBtn').addEventListener('click', function() {
            // Hiển thị trạng thái tải
            document.getElementById('confirmRepairBtn').disabled = true;
            document.getElementById('confirmRepairBtn').innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span> Sửa chữa...';
            
            // Gửi yêu cầu sửa chữa
            fetch('/api/logs/repair', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Khôi phục trạng thái nút
                document.getElementById('confirmRepairBtn').disabled = false;
                document.getElementById('confirmRepairBtn').innerHTML = 'Xác nhận sửa chữa';
                
                // Đóng hộp xác nhận Modal
                bootstrap.Modal.getInstance(document.getElementById('confirmRepairModal')).hide();
                
                // Xây dựng nội dung kết quả
                let resultHtml = '';
                if (data.status === 'success') {
                    resultHtml = `<div class="alert alert-success">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        ${data.message}
                    </div>`;
                } else {
                    resultHtml = `<div class="alert alert-danger">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        ${data.message}
                    </div>`;
                }
                
                // Hiển thị kết quả
                document.getElementById('repairResultContent').innerHTML = resultHtml;
                new bootstrap.Modal(document.getElementById('repairResultModal')).show();
                
                // Nếu thành công，3Làm mới trang tính bằng giây
                if (data.status === 'success') {
                    setTimeout(function() {
                        window.location.reload();
                    }, 3000);
                }
            })
            .catch(error => {
                // Khôi phục trạng thái nút
                document.getElementById('confirmRepairBtn').disabled = false;
                document.getElementById('confirmRepairBtn').innerHTML = 'Xác nhận sửa chữa';
                
                console.error('Khắc phục lỗi nhật ký:', error);
                
                // Xây dựng thông báo lỗi
                let resultHtml = `<div class="alert alert-danger">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    Lỗi mạng，Hãy thử lại
                </div>`;
                
                // Hiển thị kết quả
                document.getElementById('repairResultContent').innerHTML = resultHtml;
                
                // Đóng hộp xác nhận và hiển thị kết quả
                bootstrap.Modal.getInstance(document.getElementById('confirmRepairModal')).hide();
                new bootstrap.Modal(document.getElementById('repairResultModal')).show();
            });
        });
        
        // Xóa nhật ký
        document.getElementById('clearLogsBtn').addEventListener('click', function() {
            // Hiển thị hộp thoại xác nhận
            new bootstrap.Modal(document.getElementById('confirmClearModal')).show();
        });
        
        // Xác nhận để xóa
        document.getElementById('confirmClearBtn').addEventListener('click', function() {
            // Gửi một yêu cầu rõ ràng
            fetch('/api/logs/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Đóng hộp phương thức
            bootstrap.Modal.getInstance(document.getElementById('confirmClearModal')).hide();
                    // Làm mới trang
                    window.location.reload();
                } else {
                    alert('Không thể xóa nhật ký: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Xóa lỗi nhật ký:', error);
                alert('Lỗi mạng，Hãy thử lại');
            });
        });
    });
</script>
{% endblock %} 